import{googleKey as M,loadFavorites as L}from"./util-DDZ2ozR1.js";const F={Metropolitan:{center:{lat:14.6349,lng:-90.5069},zoom:11},"Las Verapaces":{center:{lat:15.2,lng:-90},zoom:9},Northeast:{center:{lat:15.8,lng:-88.5},zoom:8},Southeast:{center:{lat:14.9,lng:-90.2},zoom:8},Centre:{center:{lat:15,lng:-90},zoom:8},West:{center:{lat:14.8,lng:-91.5},zoom:8},Northwest:{center:{lat:15.3,lng:-91},zoom:8},Petén:{center:{lat:16.5,lng:-89.9},zoom:7},"South Coast":{center:{lat:14,lng:-91.7},zoom:8}},R={center:{lat:15.5,lng:-90.23},zoom:7};function D(t,a){return t>=16?"Petén":t>=14.9&&t<16&&a>=-90.5&&a<=-89?"Las Verapaces":t>=14.4&&t<=14.9&&a>=-90.9&&a<=-90.2?"Metropolitan":t<14.4&&a<=-90.5?"South Coast":a<=-91?"West":t>=15&&a<=-90.8?"Northwest":t<15&&a>=-90.3&&a<=-89?"Southeast":"Centre"}const B=function(){let t=!1,a=null;function i(){return`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(M)}&libraries=places`}function r(l){return document.querySelector(`script[src="${l}"]`)?Promise.resolve():new Promise((p,w)=>{const h=document.createElement("script");h.src=l,h.async=!0,h.defer=!0;try{h.setAttribute("loading","lazy")}catch{}h.onload=()=>p(),h.onerror=()=>w(new Error("Failed to load Google Maps script")),document.head.appendChild(h)})}async function g(){if(!t)return a||(a=(async()=>{const l=i();await r(l);const p=Date.now();for(;!(window.google&&window.google.maps);){if(Date.now()-p>15e3)throw new Error("Timed out waiting for google.maps");await new Promise(w=>setTimeout(w,50))}t=!0})(),a)}function d(l,p={}){if(!t)throw new Error("Google Maps not loaded. Call GoogleMapsAPI.load() first.");const w=typeof l=="string"?document.getElementById(l):l;if(!w)throw new Error("Map container not found: "+l);const h=new google.maps.Map(w,p),y=new Map;function I(u,m,{title:P="",icon:e=null,zIndex:n=1,onClick:o=null}={}){const s=new google.maps.Marker({map:h,position:m,title:P,icon:e,zIndex:n});return o&&s.addListener("click",()=>o(s,u)),y.set(u,s),s}function A(u){const m=y.get(u);m&&(m.setMap(null),y.delete(u))}function C(){for(const u of y.values())u.setMap(null);y.clear()}function E(u,m={}){const P=y.get(u);P&&(P.setZIndex(9999),m.bounce&&(P.setAnimation(google.maps.Animation.BOUNCE),setTimeout(()=>P.setAnimation(null),700)))}function k(u){if(u){if(typeof u=="string"){const m=F[u];m&&(h.setZoom(m.zoom),h.setCenter(m.center));return}if(u.center&&u.zoom){h.setCenter(u.center),h.setZoom(u.zoom);return}if(u.lat&&u.lng){h.setCenter(u);return}}}return{map:h,addMarker:I,removeMarker:A,clearMarkers:C,highlightMarker:E,setView:k}}return{load:g,get loaded(){return t},initMap:d,DEFAULT_COUNTRY_VIEW:R}}(),x="gtg-cache-v1",b="cache";function $(){return new Promise((t,a)=>{const i=indexedDB.open(x);i.onupgradeneeded=()=>{const r=i.result;r.objectStoreNames.contains(b)||r.createObjectStore(b,{keyPath:"key"})},i.onsuccess=()=>{const r=i.result;if(r.objectStoreNames.contains(b))t(r);else{const g=r.version+1;r.close();const d=indexedDB.open(x,g);d.onupgradeneeded=()=>{const l=d.result;l.objectStoreNames.contains(b)||l.createObjectStore(b,{keyPath:"key"})},d.onsuccess=()=>t(d.result),d.onerror=()=>a(d.error)}},i.onerror=()=>a(i.error)})}async function G(t,a){const i=await $();return new Promise((r,g)=>{const d=i.transaction(b,t),l=d.objectStore(b),p=a(l);d.oncomplete=()=>r(p.result),d.onabort=d.onerror=()=>g(d.error||new Error("IDB error"))})}async function U(t,a,i=24*60*60*1e3){try{const r={key:t,ts:Date.now(),ttl:i,value:a};return await G("readwrite",g=>g.put(r)),!0}catch(r){return console.warn("idbCache.setCache failed",r),!1}}async function j(t){try{const a=await G("readonly",i=>i.get(t));if(!a)return null;if(typeof a.ts=="number"&&typeof a.ttl=="number"&&Date.now()-a.ts>a.ttl){try{await z(t)}catch{}return null}return a.value}catch(a){return console.warn("idbCache.getCache failed",a),null}}async function z(t){try{return await G("readwrite",a=>a.delete(t)),!0}catch(a){return console.warn("idbCache.delCache failed",a),!1}}async function q(){try{const t=await $();return new Promise((a,i)=>{const r=t.transaction(b,"readwrite"),d=r.objectStore(b).openCursor();d.onsuccess=()=>{const l=d.result;if(!l)return;const p=l.value;p&&typeof p.ts=="number"&&typeof p.ttl=="number"&&Date.now()-p.ts>p.ttl&&l.delete(),l.continue()},r.oncomplete=()=>a(!0),r.onerror=()=>i(r.error)})}catch(t){return console.warn("idbCache.clearExpired failed",t),!1}}const v={setCache:U,getCache:j,delCache:z,clearExpired:q},T="places_cache_attractions_v1",O="places_cache_restaurants_v1",Z=function(){let t=[],a=[],i=null,r=!0;function g(){try{const e=sessionStorage.getItem(T),n=sessionStorage.getItem(O);e&&(t=JSON.parse(e)||[]),n&&(a=JSON.parse(n)||[])}catch(e){console.warn("Failed reading Places cache from sessionStorage",e)}}function d(){try{sessionStorage.setItem(T,JSON.stringify(t)),sessionStorage.setItem(O,JSON.stringify(a))}catch(e){console.warn("Failed saving Places cache to sessionStorage",e)}}g();try{v.clearExpired()}catch{}const l=[{placeId:"sample-1",name:"Antigua Guatemala",types:["tourist_attraction"],status:"OPERATIONAL",location:{lat:14.556,lng:-90.734},address:"Antigua Guatemala",photos:[],region:"Metropolitan",raw:{}},{placeId:"sample-2",name:"Tikal National Park",types:["park","tourist_attraction"],status:"OPERATIONAL",location:{lat:17.223,lng:-89.623},address:"Tikal",photos:[],region:"Petén",raw:{}},{placeId:"sample-3",name:"Lake Atitlán",types:["natural_feature"],status:"OPERATIONAL",location:{lat:14.704,lng:-91.186},address:"Lake Atitlán",photos:[],region:"West",raw:{}}];async function p(){try{if(await B.load(),!i&&window.google&&window.google.maps&&window.google.maps.places){const e=document.createElement("div"),n=new google.maps.Map(e);i=new google.maps.places.PlacesService(n)}i||(r=!1)}catch(e){console.warn("Google Maps failed to load, falling back to session cache if available",e),r=!1}}function w(e){const n=e.geometry&&e.geometry.location?{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()}:null,o=e.photos&&e.photos.length?e.photos.map(c=>c.getUrl({maxWidth:800})):[],s=e.photos&&e.photos.length?e.photos.map(c=>c.photo_reference).filter(Boolean):[];let f=null;if(e.opening_hours)try{typeof e.opening_hours.isOpen=="function"?f=e.opening_hours.isOpen():typeof e.opening_hours.open_now<"u"&&(f=!!e.opening_hours.open_now)}catch{}return{placeId:e.place_id,name:e.name,types:(e.types||[]).slice(0,3),status:e.business_status||null,isOpen:f,location:n,address:e.formatted_address||e.vicinity||null,photos:o,photoRefs:s,region:n?D(n.lat,n.lng):"Centre",raw:e}}function h(e){return e&&Array.isArray(e.photos)&&e.photos.length>0}function y(e){return new Promise((n,o)=>{if(!r||!i)return o(new Error("Places service not available"));i.textSearch(e,(s,f,c)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK&&f!==window.google.maps.places.PlacesServiceStatus.ZERO_RESULTS)return o(new Error("TextSearch failed: "+f));n({results:s||[],pagination:c})})})}async function I(e){try{const n=await v.getCache(`places:detail:${e}`);if(n)return n}catch{}if(await p(),!r||!i)throw new Error("Places service not available");return new Promise((n,o)=>{i.getDetails({placeId:e,fields:["place_id","name","geometry","types","business_status","formatted_address","photos","opening_hours"]},async(s,f)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK)return o(new Error("getDetails failed: "+f));const c=w(s),S=Object.assign({},c);try{delete S.raw}catch{}try{const _=await v.setCache(`places:detail:${e}`,S,864e5);console.debug(_?"PlacesAPI: cached place detail":"PlacesAPI: failed to persist place detail to idb",e)}catch(_){console.debug("PlacesAPI: idb setCache error",_)}n(c)})})}async function A(e,n="attraction"){const o=L(),s=n==="restaurant"?o.restaurants:o.destinations;if(!s||!s.length)return e;for(const f of s)if(!e.find(c=>c.placeId===f)){try{const c=await I(f);c&&h(c)&&e.push(c)}catch(c){console.warn("Failed fetching favorite by id",f,c)}if(e.length>=100)break}return e.slice(0,100)}async function C(e){await p();const n=[];if(!r)return t.length?t.slice(0,100):a.length?a.slice(0,100):(console.warn("PlacesAPI: Maps not available and no cache present; returning empty list"),[]);for(const o of e){try{const s=await v.getCache(`places:text:${o}`);if(s&&Array.isArray(s)&&s.length){for(const f of s)n.find(c=>c.placeId===f.placeId)||n.push(f);if(n.length>=100)break;continue}}catch{}try{const{results:s}=await y({query:o}),f=[];for(const c of s){const S=w(c);h(S)&&(n.find(_=>_.placeId===S.placeId)||n.push(S),f.push(S))}try{const c=f.map(_=>{const N=Object.assign({},_);try{delete N.raw}catch{}return N}).slice(0,50);await v.setCache(`places:text:${o}`,c,24*60*60*1e3)?console.debug("PlacesAPI: cached seed results for",o,c.length):console.debug("PlacesAPI: failed to persist seed cache for",o)}catch(c){console.debug("PlacesAPI: idb seed setCache error",c)}}catch(s){console.warn("textSearch seed failed",o,s)}if(n.length>=100)break}return n.slice(0,100)}async function E(){return t.length||(t=await C(["tourist attractions in Guatemala","historic sites in Guatemala","national parks Guatemala","archaeological sites Guatemala","museums Guatemala","landmarks Guatemala"]),t=t.filter(n=>h(n)),(!t||t.length===0)&&!r&&(t=l.slice()),t=await A(t,"attraction"),d()),t}async function k(e="All",n=18){if(await p(),(e==="All"||!e)&&t.length)return A(t.slice(0,n),"attraction");const o=[];e&&e!=="All"?(o.push(`${e} tourist attractions`),o.push(`top sites in ${e}`),o.push(`${e} attractions Guatemala`)):o.push("tourist attractions in Guatemala");const s=await C(o);return(await A(s,"attraction")).slice(0,n)}async function u(){return a.length?a:(a=await C(["best restaurants in Guatemala","popular restaurants Guatemala","top restaurants Guatemala","local cuisine Guatemala"]),a=a.filter(n=>n.types&&n.types.includes("restaurant")),a=a.filter(n=>h(n)),a=await A(a,"restaurant"),(!a||a.length===0)&&!r&&(a=l.map((n,o)=>({placeId:`sample-restaurant-${o+1}`,name:`${n.name} Bistro`,types:["restaurant"],status:"OPERATIONAL",location:n.location,address:n.address,photos:[],region:n.region,raw:{}}))),d(),a.slice(0,100))}async function m(e="All",n=18){if(await p(),(e==="All"||!e)&&a.length)return A(a.slice(0,n),"restaurant");const o=[];e&&e!=="All"?(o.push(`${e} restaurants`),o.push(`best restaurants in ${e}`),o.push(`${e} local cuisine`)):o.push("best restaurants in Guatemala");const s=await C(o);return(await A(s,"restaurant")).slice(0,n)}function P(e){const n={};for(const o of e){const s=o.region||"Centre";n[s]||(n[s]=[]),n[s].push(o)}return n}return{fetchAttractions:E,fetchAttractionsForRegion:k,fetchRestaurants:u,fetchRestaurantsForRegion:m,groupByRegion:P,getPlaceById:I,_internal:{get attractions(){return t},get restaurants(){return a}}}}(),K={};function W(t){return t&&Array.isArray(t.photoRefs)&&t.photoRefs.length&&M?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(t.photoRefs[0])}&key=${M}`:t.photos&&t.photos.length?t.photos[0]:`${typeof import.meta<"u"&&K?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/placeholder-2x1.svg`}function Y(t){return{id:t.placeId,name:t.name,image:W(t),types:(t.types||[]).slice(0,3),status:t.status,coords:t.location,region:t.region}}export{R as D,B as G,Z as P,F as R,Y as a,v as i};
