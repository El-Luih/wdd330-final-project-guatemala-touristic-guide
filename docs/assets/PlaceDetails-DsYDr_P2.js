import{googleKey as M,loadFavorites as F}from"./util-DDZ2ozR1.js";const z={Metropolitan:{center:{lat:14.6349,lng:-90.5069},zoom:11},"Las Verapaces":{center:{lat:15.2,lng:-90},zoom:9},Northeast:{center:{lat:15.8,lng:-88.5},zoom:8},Southeast:{center:{lat:14.9,lng:-90.2},zoom:8},Centre:{center:{lat:15,lng:-90},zoom:8},West:{center:{lat:14.8,lng:-91.5},zoom:8},Northwest:{center:{lat:15.3,lng:-91},zoom:8},Petén:{center:{lat:16.5,lng:-89.9},zoom:7},"South Coast":{center:{lat:14,lng:-91.7},zoom:8}},B={center:{lat:15.5,lng:-90.23},zoom:7};function D(t,a){return t>=16?"Petén":t>=14.9&&t<16&&a>=-90.5&&a<=-89?"Las Verapaces":t>=14.4&&t<=14.9&&a>=-90.9&&a<=-90.2?"Metropolitan":t<14.4&&a<=-90.5?"South Coast":a<=-91?"West":t>=15&&a<=-90.8?"Northwest":t<15&&a>=-90.3&&a<=-89?"Southeast":"Centre"}function Z(){try{return new URLSearchParams(location.search).get("region")||null}catch{return null}}function H(t,a){try{const r=new URL(t,location.href);return a&&a!=="All"&&r.searchParams.set("region",a),r.toString()}catch{return t}}function Q(t){if(!t)return;const a=document.querySelectorAll(".filtering-buttons button");a&&a.length&&a.forEach(s=>s.classList.toggle("active",s.dataset.region===t));const r=document.querySelector("#regions");if(r){const s=Array.from(r.options).find(m=>m.value===t||m.text===t);s&&(r.value=s.value)}}function X(){const t=document.querySelector(".filtering-buttons button.active");if(t)return t.dataset.region||"All";const a=document.querySelector("#regions");return a&&a.value||"All"}const U=function(){let t=!1,a=null;function r(){return`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(M)}&libraries=places`}function s(l){return document.querySelector(`script[src="${l}"]`)?Promise.resolve():new Promise((p,y)=>{const h=document.createElement("script");h.src=l,h.async=!0,h.defer=!0;try{h.setAttribute("loading","lazy")}catch{}h.onload=()=>p(),h.onerror=()=>y(new Error("Failed to load Google Maps script")),document.head.appendChild(h)})}async function m(){if(!t)return a||(a=(async()=>{const l=r();await s(l);const p=Date.now();for(;!(window.google&&window.google.maps);){if(Date.now()-p>15e3)throw new Error("Timed out waiting for google.maps");await new Promise(y=>setTimeout(y,50))}t=!0})(),a)}function d(l,p={}){if(!t)throw new Error("Google Maps not loaded. Call GoogleMapsAPI.load() first.");const y=typeof l=="string"?document.getElementById(l):l;if(!y)throw new Error("Map container not found: "+l);const h=new google.maps.Map(y,p),g=new Map;function E(u,w,{title:P="",icon:k=null,zIndex:e=1,onClick:n=null}={}){const o=new google.maps.Marker({map:h,position:w,title:P,icon:k,zIndex:e});return n&&o.addListener("click",()=>n(o,u)),g.set(u,o),o}function I(u){const w=g.get(u);w&&(w.setMap(null),g.delete(u))}function A(){for(const u of g.values())u.setMap(null);g.clear()}function C(u,w={}){const P=g.get(u);P&&(P.setZIndex(9999),w.bounce&&(P.setAnimation(google.maps.Animation.BOUNCE),setTimeout(()=>P.setAnimation(null),700)))}function G(u){if(u){if(typeof u=="string"){const w=z[u];w&&(h.setZoom(w.zoom),h.setCenter(w.center));return}if(u.center&&u.zoom){h.setCenter(u.center),h.setZoom(u.zoom);return}if(u.lat&&u.lng){h.setCenter(u);return}}}return{map:h,addMarker:E,removeMarker:I,clearMarkers:A,highlightMarker:C,setView:G}}return{load:m,get loaded(){return t},initMap:d,DEFAULT_COUNTRY_VIEW:B}}(),N="gtg-cache-v1",b="cache";function O(){return new Promise((t,a)=>{const r=indexedDB.open(N);r.onupgradeneeded=()=>{const s=r.result;s.objectStoreNames.contains(b)||s.createObjectStore(b,{keyPath:"key"})},r.onsuccess=()=>{const s=r.result;if(s.objectStoreNames.contains(b))t(s);else{const m=s.version+1;s.close();const d=indexedDB.open(N,m);d.onupgradeneeded=()=>{const l=d.result;l.objectStoreNames.contains(b)||l.createObjectStore(b,{keyPath:"key"})},d.onsuccess=()=>t(d.result),d.onerror=()=>a(d.error)}},r.onerror=()=>a(r.error)})}async function R(t,a){const r=await O();return new Promise((s,m)=>{const d=r.transaction(b,t),l=d.objectStore(b),p=a(l);d.oncomplete=()=>s(p.result),d.onabort=d.onerror=()=>m(d.error||new Error("IDB error"))})}async function q(t,a,r=24*60*60*1e3){try{const s={key:t,ts:Date.now(),ttl:r,value:a};return await R("readwrite",m=>m.put(s)),!0}catch(s){return console.warn("idbCache.setCache failed",s),!1}}async function V(t){try{const a=await R("readonly",r=>r.get(t));if(!a)return null;if(typeof a.ts=="number"&&typeof a.ttl=="number"&&Date.now()-a.ts>a.ttl){try{await $(t)}catch{}return null}return a.value}catch(a){return console.warn("idbCache.getCache failed",a),null}}async function $(t){try{return await R("readwrite",a=>a.delete(t)),!0}catch(a){return console.warn("idbCache.delCache failed",a),!1}}async function j(){try{const t=await O();return new Promise((a,r)=>{const s=t.transaction(b,"readwrite"),d=s.objectStore(b).openCursor();d.onsuccess=()=>{const l=d.result;if(!l)return;const p=l.value;p&&typeof p.ts=="number"&&typeof p.ttl=="number"&&Date.now()-p.ts>p.ttl&&l.delete(),l.continue()},s.oncomplete=()=>a(!0),s.onerror=()=>r(s.error)})}catch(t){return console.warn("idbCache.clearExpired failed",t),!1}}const _={setCache:q,getCache:V,delCache:$,clearExpired:j},T="places_cache_attractions_v1",x="places_cache_restaurants_v1",ee=function(){let t=[],a=[],r=null,s=!0;function m(){try{const e=sessionStorage.getItem(T),n=sessionStorage.getItem(x);e&&(t=JSON.parse(e)||[]),n&&(a=JSON.parse(n)||[])}catch(e){console.warn("Failed reading Places cache from sessionStorage",e)}}function d(){try{sessionStorage.setItem(T,JSON.stringify(t)),sessionStorage.setItem(x,JSON.stringify(a))}catch(e){console.warn("Failed saving Places cache to sessionStorage",e)}}m();try{_.clearExpired()}catch{}const l=[{placeId:"sample-1",name:"Antigua Guatemala",types:["tourist_attraction"],status:"OPERATIONAL",location:{lat:14.556,lng:-90.734},address:"Antigua Guatemala",photos:[],region:"Metropolitan",raw:{}},{placeId:"sample-2",name:"Tikal National Park",types:["park","tourist_attraction"],status:"OPERATIONAL",location:{lat:17.223,lng:-89.623},address:"Tikal",photos:[],region:"Petén",raw:{}},{placeId:"sample-3",name:"Lake Atitlán",types:["natural_feature"],status:"OPERATIONAL",location:{lat:14.704,lng:-91.186},address:"Lake Atitlán",photos:[],region:"West",raw:{}}],p={Metropolitan:["Guatemala City","Guatemala City restaurants","restaurants in Guatemala City"],"Las Verapaces":["Las Verapaces","Verapaces Guatemala","restaurants in Las Verapaces"],Petén:["Petén","Petén Guatemala","restaurants in Petén"],"South Coast":["Pacific coast Guatemala","South Coast Guatemala","restaurants on the Pacific coast Guatemala"]};async function y(){try{if(await U.load(),!r&&window.google&&window.google.maps&&window.google.maps.places){const e=document.createElement("div"),n=new google.maps.Map(e);r=new google.maps.places.PlacesService(n)}r||(s=!1)}catch(e){console.warn("Google Maps failed to load, falling back to session cache if available",e),s=!1}}function h(e){const n=e.geometry&&e.geometry.location?{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()}:null,o=e.photos&&e.photos.length?e.photos.map(i=>i.getUrl({maxWidth:800})):[],c=e.photos&&e.photos.length?e.photos.map(i=>i.photo_reference).filter(Boolean):[];let f=null;if(e.opening_hours)try{typeof e.opening_hours.isOpen=="function"?f=e.opening_hours.isOpen():typeof e.opening_hours.open_now<"u"&&(f=!!e.opening_hours.open_now)}catch{}return{placeId:e.place_id,name:e.name,types:(e.types||[]).slice(0,3),status:e.business_status||null,isOpen:f,location:n,address:e.formatted_address||e.vicinity||null,photos:o,photoRefs:c,region:n?D(n.lat,n.lng):"Centre",raw:e}}function g(e){return e&&Array.isArray(e.photos)&&e.photos.length>0}function E(e){return new Promise((n,o)=>{if(!s||!r)return o(new Error("Places service not available"));r.textSearch(e,(c,f,i)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK&&f!==window.google.maps.places.PlacesServiceStatus.ZERO_RESULTS)return o(new Error("TextSearch failed: "+f));n({results:c||[],pagination:i})})})}async function I(e){try{const n=await _.getCache(`places:detail:${e}`);if(n)return n}catch{}if(await y(),!s||!r)throw new Error("Places service not available");return new Promise((n,o)=>{r.getDetails({placeId:e,fields:["place_id","name","geometry","types","business_status","formatted_address","photos","opening_hours"]},async(c,f)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK)return o(new Error("getDetails failed: "+f));const i=h(c),S=Object.assign({},i);try{delete S.raw}catch{}try{const v=await _.setCache(`places:detail:${e}`,S,864e5);console.debug(v?"PlacesAPI: cached place detail":"PlacesAPI: failed to persist place detail to idb",e)}catch(v){console.debug("PlacesAPI: idb setCache error",v)}n(i)})})}async function A(e,n="attraction"){const o=F(),c=n==="restaurant"?o.restaurants:o.destinations;if(!c||!c.length)return e;for(const f of c)if(!e.find(i=>i.placeId===f)){try{const i=await I(f);i&&g(i)&&e.push(i)}catch(i){console.warn("Failed fetching favorite by id",f,i)}if(e.length>=100)break}return e.slice(0,100)}async function C(e){await y();const n=[];if(!s)return t.length?t.slice(0,100):a.length?a.slice(0,100):(console.warn("PlacesAPI: Maps not available and no cache present; returning empty list"),[]);for(const o of e){try{const c=await _.getCache(`places:text:${o}`);if(c&&Array.isArray(c)&&c.length){for(const f of c)n.find(i=>i.placeId===f.placeId)||n.push(f);if(n.length>=100)break;continue}}catch{}try{const{results:c}=await E({query:o}),f=[];for(const i of c){const S=h(i);g(S)&&(n.find(v=>v.placeId===S.placeId)||n.push(S),f.push(S))}try{const i=f.map(v=>{const L=Object.assign({},v);try{delete L.raw}catch{}return L}).slice(0,50);await _.setCache(`places:text:${o}`,i,24*60*60*1e3)?console.debug("PlacesAPI: cached seed results for",o,i.length):console.debug("PlacesAPI: failed to persist seed cache for",o)}catch(i){console.debug("PlacesAPI: idb seed setCache error",i)}}catch(c){console.warn("textSearch seed failed",o,c)}if(n.length>=100)break}return n.slice(0,100)}async function G(){return t.length||(t=await C(["tourist attractions in Guatemala","historic sites in Guatemala","national parks Guatemala","archaeological sites Guatemala","museums Guatemala","landmarks Guatemala"]),t=t.filter(n=>g(n)),(!t||t.length===0)&&!s&&(t=l.slice()),t=await A(t,"attraction"),d()),t}async function u(e="All",n=18){if(await y(),(e==="All"||!e)&&t.length)return A(t.slice(0,n),"attraction");const o=[];e&&e!=="All"?(o.push(`${e} tourist attractions`),o.push(`top sites in ${e}`),o.push(`${e} attractions Guatemala`)):o.push("tourist attractions in Guatemala");const c=await C(o);return(await A(c,"attraction")).slice(0,n)}async function w(){return a.length?a:(a=await C(["best restaurants in Guatemala","popular restaurants Guatemala","top restaurants Guatemala","local cuisine Guatemala"]),a=a.filter(n=>n.types&&n.types.includes("restaurant")),a=a.filter(n=>g(n)),a=await A(a,"restaurant"),(!a||a.length===0)&&!s&&(a=l.map((n,o)=>({placeId:`sample-restaurant-${o+1}`,name:`${n.name} Bistro`,types:["restaurant"],status:"OPERATIONAL",location:n.location,address:n.address,photos:[],region:n.region,raw:{}}))),d(),a.slice(0,100))}async function P(e="All",n=18){if(await y(),(e==="All"||!e)&&a.length)return A(a.slice(0,n),"restaurant");let o=[];e&&e!=="All"?p[e]?o=p[e].slice():(o.push(`${e} restaurants`),o.push(`best restaurants in ${e}`),o.push(`${e} local cuisine`)):o.push("best restaurants in Guatemala");let c=await C(o);if((!c||c.length===0)&&e&&e!=="All"){const i=["best restaurants in Guatemala","popular restaurants Guatemala",`${e} near Guatemala City`];c=await C(i)}return(await A(c,"restaurant")).slice(0,n)}function k(e){const n={};for(const o of e){const c=o.region||"Centre";n[c]||(n[c]=[]),n[c].push(o)}return n}return{fetchAttractions:G,fetchAttractionsForRegion:u,fetchRestaurants:w,fetchRestaurantsForRegion:P,groupByRegion:k,getPlaceById:I,_internal:{get attractions(){return t},get restaurants(){return a}}}}(),K={};function W(t){return t&&Array.isArray(t.photoRefs)&&t.photoRefs.length&&M?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(t.photoRefs[0])}&key=${M}`:t.photos&&t.photos.length?t.photos[0]:`${typeof import.meta<"u"&&K?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/placeholder-2x1.svg`}function te(t){return{id:t.placeId,name:t.name,image:W(t),types:(t.types||[]).slice(0,3),status:t.status,coords:t.location,region:t.region}}export{B as D,U as G,ee as P,z as R,te as a,H as b,Z as c,Q as d,X as g,_ as i};
