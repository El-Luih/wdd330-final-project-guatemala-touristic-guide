import{googleKey as N,loadFavorites as $}from"./util-DDZ2ozR1.js";const B={Metropolitan:{center:{lat:14.6349,lng:-90.5069},zoom:11},"Las Verapaces":{center:{lat:15.2,lng:-90},zoom:9},Northeast:{center:{lat:15.8,lng:-88.5},zoom:8},Southeast:{center:{lat:14.9,lng:-90.2},zoom:8},Center:{center:{lat:15,lng:-90},zoom:8},West:{center:{lat:14.8,lng:-91.5},zoom:8},Northwest:{center:{lat:15.3,lng:-91},zoom:8},Petén:{center:{lat:16.5,lng:-89.9},zoom:7},"South Coast":{center:{lat:14,lng:-91.7},zoom:8}},D={center:{lat:15.5,lng:-90.23},zoom:7};function U(e,a){return e>=16?"Petén":e>=15.5&&a>=-89.5?"Northeast":e>=14.9&&e<16&&a>=-90.5&&a<=-89?"Las Verapaces":e>=14.4&&e<=14.9&&a>=-90.9&&a<=-90.2?"Metropolitan":e<14.4&&a<=-90.5?"South Coast":a<=-91?"West":e>=15&&a<=-90.8?"Northwest":e<15&&a>=-90.3&&a<=-89?"Southeast":"Center"}function Y(){try{return new URLSearchParams(location.search).get("region")||null}catch{return null}}function Z(e,a){try{const r=new URL(e,location.href);return a&&a!=="All"&&r.searchParams.set("region",a),r.toString()}catch{return e}}function H(e){if(!e)return;const a=document.querySelectorAll(".filtering-buttons button");a&&a.length&&a.forEach(o=>o.classList.toggle("active",o.dataset.region===e));const r=document.querySelector("#regions");if(r){const o=Array.from(r.options).find(m=>m.value===e||m.text===e);o&&(r.value=o.value)}}function X(){const e=document.querySelector(".filtering-buttons button.active");if(e)return e.dataset.region||"All";const a=document.querySelector("#regions");return a&&a.value||"All"}const q=function(){let e=!1,a=null;function r(){return`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(N)}&libraries=places`}function o(l){return document.querySelector(`script[src="${l}"]`)?Promise.resolve():new Promise((p,A)=>{const h=document.createElement("script");h.src=l,h.async=!0,h.defer=!0;try{h.setAttribute("loading","lazy")}catch{}h.onload=()=>p(),h.onerror=()=>A(new Error("Failed to load Google Maps script")),document.head.appendChild(h)})}async function m(){if(!e)return a||(a=(async()=>{const l=r();await o(l);const p=Date.now();for(;!(window.google&&window.google.maps);){if(Date.now()-p>15e3)throw new Error("Timed out waiting for google.maps");await new Promise(A=>setTimeout(A,50))}e=!0})(),a)}function d(l,p={}){if(!e)throw new Error("Google Maps not loaded. Call GoogleMapsAPI.load() first.");const A=typeof l=="string"?document.getElementById(l):l;if(!A)throw new Error("Map container not found: "+l);const h=new google.maps.Map(A,p),w=new Map;function k(u,b,{title:S="",icon:F=null,zIndex:t=1,onClick:n=null}={}){const s=new google.maps.Marker({map:h,position:b,title:S,icon:F,zIndex:t});return n&&s.addListener("click",()=>n(s,u)),w.set(u,s),s}function G(u){const b=w.get(u);b&&(b.setMap(null),w.delete(u))}function y(){for(const u of w.values())u.setMap(null);w.clear()}function _(u,b={}){const S=w.get(u);S&&(S.setZIndex(9999),b.bounce&&(S.setAnimation(google.maps.Animation.BOUNCE),setTimeout(()=>S.setAnimation(null),700)))}function M(u){if(u){if(typeof u=="string"){const b=B[u];b&&(h.setZoom(b.zoom),h.setCenter(b.center));return}if(u.center&&u.zoom){h.setCenter(u.center),h.setZoom(u.zoom);return}if(u.lat&&u.lng){h.setCenter(u);return}}}return{map:h,addMarker:k,removeMarker:G,clearMarkers:y,highlightMarker:_,setView:M}}return{load:m,get loaded(){return e},initMap:d,DEFAULT_COUNTRY_VIEW:D}}(),z="gtg-cache-v1",v="cache";function T(){return new Promise((e,a)=>{const r=indexedDB.open(z);r.onupgradeneeded=()=>{const o=r.result;o.objectStoreNames.contains(v)||o.createObjectStore(v,{keyPath:"key"})},r.onsuccess=()=>{const o=r.result;if(o.objectStoreNames.contains(v))e(o);else{const m=o.version+1;o.close();const d=indexedDB.open(z,m);d.onupgradeneeded=()=>{const l=d.result;l.objectStoreNames.contains(v)||l.createObjectStore(v,{keyPath:"key"})},d.onsuccess=()=>e(d.result),d.onerror=()=>a(d.error)}},r.onerror=()=>a(r.error)})}async function R(e,a){const r=await T();return new Promise((o,m)=>{const d=r.transaction(v,e),l=d.objectStore(v),p=a(l);d.oncomplete=()=>o(p.result),d.onabort=d.onerror=()=>m(d.error||new Error("IDB error"))})}async function V(e,a,r=24*60*60*1e3){try{const o={key:e,ts:Date.now(),ttl:r,value:a};return await R("readwrite",m=>m.put(o)),!0}catch(o){return console.warn("idbCache.setCache failed",o),!1}}async function j(e){try{const a=await R("readonly",r=>r.get(e));if(!a)return null;if(typeof a.ts=="number"&&typeof a.ttl=="number"&&Date.now()-a.ts>a.ttl){try{await O(e)}catch{}return null}return a.value}catch(a){return console.warn("idbCache.getCache failed",a),null}}async function O(e){try{return await R("readwrite",a=>a.delete(e)),!0}catch(a){return console.warn("idbCache.delCache failed",a),!1}}async function J(){try{const e=await T();return new Promise((a,r)=>{const o=e.transaction(v,"readwrite"),d=o.objectStore(v).openCursor();d.onsuccess=()=>{const l=d.result;if(!l)return;const p=l.value;p&&typeof p.ts=="number"&&typeof p.ttl=="number"&&Date.now()-p.ts>p.ttl&&l.delete(),l.continue()},o.oncomplete=()=>a(!0),o.onerror=()=>r(o.error)})}catch(e){return console.warn("idbCache.clearExpired failed",e),!1}}const E={setCache:V,getCache:j,delCache:O,clearExpired:J},L="places_cache_attractions_v1",x="places_cache_restaurants_v1",tt=function(){let e=[],a=[],r=null,o=!0;function m(){try{const t=sessionStorage.getItem(L),n=sessionStorage.getItem(x);t&&(e=JSON.parse(t)||[]),n&&(a=JSON.parse(n)||[])}catch(t){console.warn("Failed reading Places cache from sessionStorage",t)}}function d(){try{sessionStorage.setItem(L,JSON.stringify(e)),sessionStorage.setItem(x,JSON.stringify(a))}catch(t){console.warn("Failed saving Places cache to sessionStorage",t)}}m();try{E.clearExpired()}catch{}const l=[{placeId:"sample-1",name:"Antigua Guatemala",types:["tourist_attraction"],status:"OPERATIONAL",location:{lat:14.556,lng:-90.734},address:"Antigua Guatemala",photos:[],region:"Metropolitan",raw:{}},{placeId:"sample-2",name:"Tikal National Park",types:["park","tourist_attraction"],status:"OPERATIONAL",location:{lat:17.223,lng:-89.623},address:"Tikal",photos:[],region:"Petén",raw:{}},{placeId:"sample-3",name:"Lake Atitlán",types:["natural_feature"],status:"OPERATIONAL",location:{lat:14.704,lng:-91.186},address:"Lake Atitlán",photos:[],region:"West",raw:{}}],p={Metropolitan:["Guatemala City","Guatemala City restaurants","restaurants in Guatemala City"],"Las Verapaces":["Las Verapaces","Verapaces Guatemala","restaurants in Las Verapaces"],Petén:["Petén","Petén Guatemala","restaurants in Petén"],"South Coast":["Pacific coast Guatemala","South Coast Guatemala","restaurants on the Pacific coast Guatemala"],West:["Quetzaltenango","Quetzaltenango restaurants","restaurants in Quetzaltenango"],Southeast:["Jutiapa","Jutiapa Guatemala restaurants","restaurants in Jutiapa"],Northeast:["Izabal","Izabal Guatemala restaurants","restaurants in Izabal"]};async function A(){try{if(await q.load(),!r&&window.google&&window.google.maps&&window.google.maps.places){const t=document.createElement("div"),n=new google.maps.Map(t);r=new google.maps.places.PlacesService(n)}r||(o=!1)}catch(t){console.warn("Google Maps failed to load, falling back to session cache if available",t),o=!1}}function h(t){const n=t.geometry&&t.geometry.location?{lat:t.geometry.location.lat(),lng:t.geometry.location.lng()}:null,s=t.photos&&t.photos.length?t.photos.map(i=>i.getUrl({maxWidth:800})):[],c=t.photos&&t.photos.length?t.photos.map(i=>i.photo_reference).filter(Boolean):[];let f=null;if(t.opening_hours)try{typeof t.opening_hours.isOpen=="function"?f=t.opening_hours.isOpen():typeof t.opening_hours.open_now<"u"&&(f=!!t.opening_hours.open_now)}catch{}return{placeId:t.place_id,name:t.name,types:(t.types||[]).slice(0,3),status:t.business_status||null,isOpen:f,location:n,address:t.formatted_address||t.vicinity||null,photos:s,photoRefs:c,region:n?U(n.lat,n.lng):"Center",raw:t}}function w(t){return t&&Array.isArray(t.photos)&&t.photos.length>0}function k(t){return new Promise((n,s)=>{if(!o||!r)return s(new Error("Places service not available"));r.textSearch(t,(c,f,i)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK&&f!==window.google.maps.places.PlacesServiceStatus.ZERO_RESULTS)return s(new Error("TextSearch failed: "+f));n({results:c||[],pagination:i})})})}async function G(t){try{const n=await E.getCache(`places:detail:${t}`);if(n)return n}catch{}if(await A(),!o||!r)throw new Error("Places service not available");return new Promise((n,s)=>{r.getDetails({placeId:t,fields:["place_id","name","geometry","types","business_status","formatted_address","photos","opening_hours"]},async(c,f)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK)return s(new Error("getDetails failed: "+f));const i=h(c),P=Object.assign({},i);try{delete P.raw}catch{}try{const g=await E.setCache(`places:detail:${t}`,P,864e5);console.debug(g?"PlacesAPI: cached place detail":"PlacesAPI: failed to persist place detail to idb",t)}catch(g){console.debug("PlacesAPI: idb setCache error",g)}n(i)})})}async function y(t,n="attraction"){const s=$(),c=n==="restaurant"?s.restaurants:s.destinations;if(!c||!c.length)return t;for(const f of c)if(!t.find(i=>i.placeId===f)){try{const i=await G(f);i&&w(i)&&t.push(i)}catch(i){console.warn("Failed fetching favorite by id",f,i)}if(t.length>=100)break}return t.slice(0,100)}async function _(t){await A();const n=[];if(!o)return e.length?e.slice(0,100):a.length?a.slice(0,100):(console.warn("PlacesAPI: Maps not available and no cache present; returning empty list"),[]);for(const s of t){try{const c=await E.getCache(`places:text:${s}`);if(c&&Array.isArray(c)&&c.length){for(const f of c)n.find(i=>i.placeId===f.placeId)||n.push(f);if(n.length>=100)break;continue}}catch{}try{const{results:c}=await k({query:s}),f=[];for(const i of c){const P=h(i);w(P)&&(n.find(g=>g.placeId===P.placeId)||n.push(P),f.push(P))}try{const i=f.map(g=>{const I=Object.assign({},g);try{delete I.raw}catch{}return I}).slice(0,50);await E.setCache(`places:text:${s}`,i,24*60*60*1e3)?console.debug("PlacesAPI: cached seed results for",s,i.length):console.debug("PlacesAPI: failed to persist seed cache for",s)}catch(i){console.debug("PlacesAPI: idb seed setCache error",i)}}catch(c){console.warn("textSearch seed failed",s,c)}if(n.length>=100)break}return n.slice(0,100)}async function M(){return e.length||(e=await _(["tourist attractions in Guatemala","historic sites in Guatemala","national parks Guatemala","archaeological sites Guatemala","museums Guatemala","landmarks Guatemala"]),e=e.filter(n=>w(n)),(!e||e.length===0)&&!o&&(e=l.slice()),e=await y(e,"attraction"),d()),e}async function u(t="All",n=18){if(await A(),(t==="All"||!t)&&e.length)return y(e.slice(0,n),"attraction");const s=[];t&&t!=="All"?(s.push(`${t} tourist attractions`),s.push(`top sites in ${t}`),s.push(`${t} attractions Guatemala`)):s.push("tourist attractions in Guatemala");const c=await _(s);return(await y(c,"attraction")).slice(0,n)}async function b(){return a.length?a:(a=await _(["best restaurants in Guatemala","popular restaurants Guatemala","top restaurants Guatemala","local cuisine Guatemala"]),a=a.filter(n=>n.types&&n.types.includes("restaurant")),a=a.filter(n=>w(n)),a=await y(a,"restaurant"),(!a||a.length===0)&&!o&&(a=l.map((n,s)=>({placeId:`sample-restaurant-${s+1}`,name:`${n.name} Bistro`,types:["restaurant"],status:"OPERATIONAL",location:n.location,address:n.address,photos:[],region:n.region,raw:{}}))),d(),a.slice(0,100))}async function S(t="All",n=18){if(await A(),(t==="All"||!t)&&a.length)return y(a.slice(0,n),"restaurant");let s=[];t&&t!=="All"?p[t]?s=p[t].slice():(s.push(`${t} restaurants`),s.push(`best restaurants in ${t}`),s.push(`${t} local cuisine`)):s.push("best restaurants in Guatemala");let c=await _(s);if(t&&t!=="All"){const i=(c||[]).filter(C=>C.region===t);if(i&&i.length)return(await y(i,"restaurant")).slice(0,n);const P=["best restaurants in Guatemala","popular restaurants Guatemala",`${t} near Guatemala City`],g=await _(P),I=(g||[]).filter(C=>C.region===t);return I&&I.length?(await y(I,"restaurant")).slice(0,n):c&&c.length?(await y(c,"restaurant")).slice(0,n):g&&g.length?(await y(g,"restaurant")).slice(0,n):[]}return(await y(c,"restaurant")).slice(0,n)}function F(t){const n={};for(const s of t){const c=s.region||"Center";n[c]||(n[c]=[]),n[c].push(s)}return n}return{fetchAttractions:M,fetchAttractionsForRegion:u,fetchRestaurants:b,fetchRestaurantsForRegion:S,groupByRegion:F,getPlaceById:G,_internal:{get attractions(){return e},get restaurants(){return a}}}}(),W={};function K(e){return e.photos&&e.photos.length?e.photos[0]:e&&Array.isArray(e.photoRefs)&&e.photoRefs.length&&N?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(e.photoRefs[0])}&key=${N}`:`${typeof import.meta<"u"&&W?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/placeholder-2x1.svg`}function et(e){return{id:e.placeId,name:e.name,image:K(e),types:(e.types||[]).slice(0,3),status:e.status,coords:e.location,region:e.region}}export{D,q as G,tt as P,B as R,et as a,Z as b,Y as c,H as d,X as g,E as i};
