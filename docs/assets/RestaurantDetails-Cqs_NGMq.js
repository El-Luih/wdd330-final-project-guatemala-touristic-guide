import{googleKey as G,loadFavorites as O}from"./util-DDZ2ozR1.js";const U={Metropolitan:{center:{lat:14.6349,lng:-90.5069},zoom:11},"Las Verapaces":{center:{lat:15.2,lng:-90},zoom:9},Northeast:{center:{lat:15.8,lng:-88.5},zoom:8},Southeast:{center:{lat:14.9,lng:-90.2},zoom:8},Center:{center:{lat:15,lng:-90},zoom:8},West:{center:{lat:14.8,lng:-91.5},zoom:8},Northwest:{center:{lat:15.3,lng:-91},zoom:8},Petén:{center:{lat:16.5,lng:-89.9},zoom:7},"South Coast":{center:{lat:14,lng:-91.7},zoom:8}},B={center:{lat:15.5,lng:-90.23},zoom:7};function D(t,a){return t>=16?"Petén":t>=15.5&&a>=-89.5?"Northeast":t>=14.9&&t<16&&a>=-90.5&&a<=-89?"Las Verapaces":t>=14.4&&t<=14.9&&a>=-90.9&&a<=-90.2?"Metropolitan":t<14.4&&a<=-90.5?"South Coast":a<=-91?"West":t>=15&&a<=-90.8?"Northwest":t<15&&a>=-90.3&&a<=-89?"Southeast":"Center"}function H(){try{return new URLSearchParams(location.search).get("region")||null}catch{return null}}function X(t,a){try{const r=new URL(t,location.href);return a&&a!=="All"&&r.searchParams.set("region",a),r.toString()}catch{return t}}function tt(t){if(!t)return;const a=document.querySelectorAll(".filtering-buttons button");a&&a.length&&a.forEach(s=>s.classList.toggle("active",s.dataset.region===t));const r=document.querySelector("#regions");if(r){const s=Array.from(r.options).find(m=>m.value===t||m.text===t);s&&(r.value=s.value)}}function et(){const t=document.querySelector(".filtering-buttons button.active");if(t)return t.dataset.region||"All";const a=document.querySelector("#regions");return a&&a.value||"All"}const q=function(){let t=!1,a=null;function r(){return`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(G)}&libraries=places`}function s(l){return document.querySelector(`script[src="${l}"]`)?Promise.resolve():new Promise((p,A)=>{const h=document.createElement("script");h.src=l,h.async=!0,h.defer=!0;try{h.setAttribute("loading","lazy")}catch{}h.onload=()=>p(),h.onerror=()=>A(new Error("Failed to load Google Maps script")),document.head.appendChild(h)})}async function m(){if(!t)return a||(a=(async()=>{const l=r();await s(l);const p=Date.now();for(;!(window.google&&window.google.maps);){if(Date.now()-p>15e3)throw new Error("Timed out waiting for google.maps");await new Promise(A=>setTimeout(A,50))}t=!0})(),a)}function d(l,p={}){if(!t)throw new Error("Google Maps not loaded. Call GoogleMapsAPI.load() first.");const A=typeof l=="string"?document.getElementById(l):l;if(!A)throw new Error("Map container not found: "+l);const h=new google.maps.Map(A,p),w=new Map;function R(u,b,{title:S="",icon:F=null,zIndex:e=1,onClick:n=null}={}){const o=new google.maps.Marker({map:h,position:b,title:S,icon:F,zIndex:e});return n&&o.addListener("click",()=>n(o,u)),w.set(u,o),o}function k(u){const b=w.get(u);b&&(b.setMap(null),w.delete(u))}function y(){for(const u of w.values())u.setMap(null);w.clear()}function C(u,b={}){const S=w.get(u);S&&(S.setZIndex(9999),b.bounce&&(S.setAnimation(google.maps.Animation.BOUNCE),setTimeout(()=>S.setAnimation(null),700)))}function M(u){if(u){if(typeof u=="string"){const b=U[u];b&&(h.setZoom(b.zoom),h.setCenter(b.center));return}if(u.center&&u.zoom){h.setCenter(u.center),h.setZoom(u.zoom);return}if(u.lat&&u.lng){h.setCenter(u);return}}}return{map:h,addMarker:R,removeMarker:k,clearMarkers:y,highlightMarker:C,setView:M}}return{load:m,get loaded(){return t},initMap:d,DEFAULT_COUNTRY_VIEW:B}}(),L="gtg-cache-v1",P="cache";function $(){return new Promise((t,a)=>{const r=indexedDB.open(L);r.onupgradeneeded=()=>{const s=r.result;s.objectStoreNames.contains(P)||s.createObjectStore(P,{keyPath:"key"})},r.onsuccess=()=>{const s=r.result;if(s.objectStoreNames.contains(P))t(s);else{const m=s.version+1;s.close();const d=indexedDB.open(L,m);d.onupgradeneeded=()=>{const l=d.result;l.objectStoreNames.contains(P)||l.createObjectStore(P,{keyPath:"key"})},d.onsuccess=()=>t(d.result),d.onerror=()=>a(d.error)}},r.onerror=()=>a(r.error)})}async function x(t,a){const r=await $();return new Promise((s,m)=>{const d=r.transaction(P,t),l=d.objectStore(P),p=a(l);d.oncomplete=()=>s(p.result),d.onabort=d.onerror=()=>m(d.error||new Error("IDB error"))})}async function V(t,a,r=24*60*60*1e3){try{const s={key:t,ts:Date.now(),ttl:r,value:a};return await x("readwrite",m=>m.put(s)),!0}catch(s){return console.warn("idbCache.setCache failed",s),!1}}async function j(t){try{const a=await x("readonly",r=>r.get(t));if(!a)return null;if(typeof a.ts=="number"&&typeof a.ttl=="number"&&Date.now()-a.ts>a.ttl){try{await T(t)}catch{}return null}return a.value}catch(a){return console.warn("idbCache.getCache failed",a),null}}async function T(t){try{return await x("readwrite",a=>a.delete(t)),!0}catch(a){return console.warn("idbCache.delCache failed",a),!1}}async function J(){try{const t=await $();return new Promise((a,r)=>{const s=t.transaction(P,"readwrite"),d=s.objectStore(P).openCursor();d.onsuccess=()=>{const l=d.result;if(!l)return;const p=l.value;p&&typeof p.ts=="number"&&typeof p.ttl=="number"&&Date.now()-p.ts>p.ttl&&l.delete(),l.continue()},s.oncomplete=()=>a(!0),s.onerror=()=>r(s.error)})}catch(t){return console.warn("idbCache.clearExpired failed",t),!1}}const E={setCache:V,getCache:j,delCache:T,clearExpired:J},N="places_cache_attractions_v1",z="places_cache_restaurants_v1",at=function(){let t=[],a=[],r=null,s=!0;function m(){try{const e=sessionStorage.getItem(N),n=sessionStorage.getItem(z);e&&(t=JSON.parse(e)||[]),n&&(a=JSON.parse(n)||[])}catch(e){console.warn("Failed reading Places cache from sessionStorage",e)}}function d(){try{sessionStorage.setItem(N,JSON.stringify(t)),sessionStorage.setItem(z,JSON.stringify(a))}catch(e){console.warn("Failed saving Places cache to sessionStorage",e)}}m();try{E.clearExpired()}catch{}const l=[{placeId:"sample-1",name:"Antigua Guatemala",types:["tourist_attraction"],status:"OPERATIONAL",location:{lat:14.556,lng:-90.734},address:"Antigua Guatemala",photos:[],region:"Metropolitan",raw:{}},{placeId:"sample-2",name:"Tikal National Park",types:["park","tourist_attraction"],status:"OPERATIONAL",location:{lat:17.223,lng:-89.623},address:"Tikal",photos:[],region:"Petén",raw:{}},{placeId:"sample-3",name:"Lake Atitlán",types:["natural_feature"],status:"OPERATIONAL",location:{lat:14.704,lng:-91.186},address:"Lake Atitlán",photos:[],region:"West",raw:{}}],p={Metropolitan:["Guatemala City","Guatemala City restaurants","restaurants in Guatemala City"],"Las Verapaces":["Las Verapaces","Verapaces Guatemala","restaurants in Las Verapaces"],Petén:["Petén","Petén Guatemala","restaurants in Petén"],"South Coast":["Pacific coast Guatemala","South Coast Guatemala","restaurants on the Pacific coast Guatemala"],West:["Quetzaltenango","Quetzaltenango restaurants","restaurants in Quetzaltenango"],Southeast:["Jutiapa","Jutiapa Guatemala restaurants","restaurants in Jutiapa"],Northeast:["Izabal","Izabal Guatemala restaurants","restaurants in Izabal"]};async function A(){try{if(await q.load(),!r&&window.google&&window.google.maps&&window.google.maps.places){const e=document.createElement("div"),n=new google.maps.Map(e);r=new google.maps.places.PlacesService(n)}r||(s=!1)}catch(e){console.warn("Google Maps failed to load, falling back to session cache if available",e),s=!1}}function h(e){const n=e.geometry&&e.geometry.location?{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()}:null,o=e.photos&&e.photos.length?e.photos.map(c=>c.getUrl({maxWidth:800})):[],i=e.photos&&e.photos.length?e.photos.map(c=>c.photo_reference).filter(Boolean):[];let f=null;if(e.opening_hours)try{typeof e.opening_hours.isOpen=="function"?f=e.opening_hours.isOpen():typeof e.opening_hours.open_now<"u"&&(f=!!e.opening_hours.open_now)}catch{}return{placeId:e.place_id,name:e.name,types:(e.types||[]).slice(0,3),status:e.business_status||null,isOpen:f,location:n,address:e.formatted_address||e.vicinity||null,photos:o,photoRefs:i,region:n?D(n.lat,n.lng):"Center",raw:e}}function w(e){return e&&Array.isArray(e.photos)&&e.photos.length>0}function R(e){return new Promise((n,o)=>{if(!s||!r)return o(new Error("Places service not available"));r.textSearch(e,(i,f,c)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK&&f!==window.google.maps.places.PlacesServiceStatus.ZERO_RESULTS)return o(new Error("TextSearch failed: "+f));n({results:i||[],pagination:c})})})}async function k(e){try{const n=await E.getCache(`places:detail:${e}`);if(n)return n}catch{}if(await A(),!s||!r)throw new Error("Places service not available");return new Promise((n,o)=>{r.getDetails({placeId:e,fields:["place_id","name","geometry","types","business_status","formatted_address","photos","opening_hours"]},async(i,f)=>{if(f!==window.google.maps.places.PlacesServiceStatus.OK)return o(new Error("getDetails failed: "+f));const c=h(i),v=Object.assign({},c);try{delete v.raw}catch{}try{const g=await E.setCache(`places:detail:${e}`,v,864e5);console.debug(g?"PlacesAPI: cached place detail":"PlacesAPI: failed to persist place detail to idb",e)}catch(g){console.debug("PlacesAPI: idb setCache error",g)}n(c)})})}async function y(e,n="attraction"){const o=O(),i=n==="restaurant"?o.restaurants:o.destinations;if(!i||!i.length)return e;for(const f of i)if(!e.find(c=>c.placeId===f)){try{const c=await k(f);c&&w(c)&&e.push(c)}catch(c){console.warn("Failed fetching favorite by id",f,c)}if(e.length>=100)break}return e.slice(0,100)}async function C(e){await A();const n=[];if(!s)return t.length?t.slice(0,100):a.length?a.slice(0,100):(console.warn("PlacesAPI: Maps not available and no cache present; returning empty list"),[]);for(const o of e){try{const i=await E.getCache(`places:text:${o}`);if(i&&Array.isArray(i)&&i.length){for(const f of i)n.find(c=>c.placeId===f.placeId)||n.push(f);if(n.length>=100)break;continue}}catch{}try{const{results:i}=await R({query:o}),f=[];for(const c of i){const v=h(c);w(v)&&(n.find(g=>g.placeId===v.placeId)||n.push(v),f.push(v))}try{const c=f.map(g=>{const I=Object.assign({},g);try{delete I.raw}catch{}return I}).slice(0,50);await E.setCache(`places:text:${o}`,c,24*60*60*1e3)?console.debug("PlacesAPI: cached seed results for",o,c.length):console.debug("PlacesAPI: failed to persist seed cache for",o)}catch(c){console.debug("PlacesAPI: idb seed setCache error",c)}}catch(i){console.warn("textSearch seed failed",o,i)}if(n.length>=100)break}return n.slice(0,100)}async function M(){return t.length||(t=await C(["tourist attractions in Guatemala","historic sites in Guatemala","national parks Guatemala","archaeological sites Guatemala","museums Guatemala","landmarks Guatemala"]),t=t.filter(n=>w(n)),(!t||t.length===0)&&!s&&(t=l.slice()),t=await y(t,"attraction"),d()),t}async function u(e="All",n=18){if(await A(),(e==="All"||!e)&&t.length)return y(t.slice(0,n),"attraction");const o=[];e&&e!=="All"?(o.push(`${e} tourist attractions`),o.push(`top sites in ${e}`),o.push(`${e} attractions Guatemala`)):o.push("tourist attractions in Guatemala");const i=await C(o);return(await y(i,"attraction")).slice(0,n)}async function b(){return a.length?a:(a=await C(["best restaurants in Guatemala","popular restaurants Guatemala","top restaurants Guatemala","local cuisine Guatemala"]),a=a.filter(n=>n.types&&n.types.includes("restaurant")),a=a.filter(n=>w(n)),a=await y(a,"restaurant"),(!a||a.length===0)&&!s&&(a=l.map((n,o)=>({placeId:`sample-restaurant-${o+1}`,name:`${n.name} Bistro`,types:["restaurant"],status:"OPERATIONAL",location:n.location,address:n.address,photos:[],region:n.region,raw:{}}))),d(),a.slice(0,100))}async function S(e="All",n=18){if(await A(),(e==="All"||!e)&&a.length)return y(a.slice(0,n),"restaurant");let o=[];e&&e!=="All"?p[e]?o=p[e].slice():(o.push(`${e} restaurants`),o.push(`best restaurants in ${e}`),o.push(`${e} local cuisine`)):o.push("best restaurants in Guatemala");let i=await C(o);if(e&&e!=="All"){const c=(i||[]).filter(_=>_.region===e);if(c&&c.length)return(await y(c,"restaurant")).slice(0,n);const v=["best restaurants in Guatemala","popular restaurants Guatemala",`${e} near Guatemala City`],g=await C(v),I=(g||[]).filter(_=>_.region===e);return I&&I.length?(await y(I,"restaurant")).slice(0,n):i&&i.length?(await y(i,"restaurant")).slice(0,n):g&&g.length?(await y(g,"restaurant")).slice(0,n):[]}return(await y(i,"restaurant")).slice(0,n)}function F(e){const n={};for(const o of e){const i=o.region||"Center";n[i]||(n[i]=[]),n[i].push(o)}return n}return{fetchAttractions:M,fetchAttractionsForRegion:u,fetchRestaurants:b,fetchRestaurantsForRegion:S,groupByRegion:F,getPlaceById:k,_internal:{get attractions(){return t},get restaurants(){return a}}}}(),W={};function K(t){return t.photos&&t.photos.length?t.photos[0]:t&&Array.isArray(t.photoRefs)&&t.photoRefs.length&&G?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(t.photoRefs[0])}&key=${G}`:`${typeof import.meta<"u"&&W?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/placeholder-2x1.svg`}function nt(t){return{id:t.placeId,name:t.name,image:K(t),types:(t.types||[]).slice(0,3),status:t.status,coords:t.location,region:t.region}}const Q={};function Y(t){return t.photos&&t.photos.length?t.photos[0]:t&&Array.isArray(t.photoRefs)&&t.photoRefs.length&&G?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(t.photoRefs[0])}&key=${G}`:`${typeof import.meta<"u"&&Q?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/restaurant-placeholder-1x1.svg`}function ot(t){return{id:t.placeId,name:t.name,logo:Y(t),types:(t.types||[]).slice(0,3),status:t.status,coords:t.location,region:t.region}}export{B as D,q as G,at as P,U as R,nt as a,tt as b,X as c,et as d,H as g,E as i,ot as r};
