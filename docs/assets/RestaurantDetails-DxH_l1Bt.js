import{googleKey as k,loadFavorites as B}from"./util-DBCvD-ly.js";const D={Metropolitan:{center:{lat:14.6349,lng:-90.5069},zoom:11},"Las Verapaces":{center:{lat:15.2,lng:-90},zoom:9},Northeast:{center:{lat:15.8,lng:-88.5},zoom:8},Southeast:{center:{lat:14.9,lng:-90.2},zoom:8},Center:{center:{lat:15,lng:-90},zoom:8},West:{center:{lat:14.8,lng:-91.5},zoom:8},Northwest:{center:{lat:15.3,lng:-91},zoom:8},Petén:{center:{lat:16.5,lng:-89.9},zoom:7},"South Coast":{center:{lat:14,lng:-91.7},zoom:8}},U={center:{lat:15.5,lng:-90.23},zoom:7};function V(t,a){return t>=16?"Petén":t>=15.5&&a>=-89.5?"Northeast":t>=14.9&&t<16&&a>=-90.5&&a<=-89?"Las Verapaces":t>=14.4&&t<=14.9&&a>=-90.9&&a<=-90.2?"Metropolitan":t<14.4&&a<=-90.5?"South Coast":a<=-91?"West":t>=15&&a<=-90.8?"Northwest":t<15&&a>=-90.3&&a<=-89?"Southeast":"Center"}function ee(){try{return new URLSearchParams(location.search).get("region")||null}catch{return null}}function te(t,a){try{const l=new URL(t,location.href);return a&&a!=="All"&&l.searchParams.set("region",a),l.toString()}catch{return t}}function ae(t){if(!t)return;const a=document.querySelectorAll(".filtering-buttons button");a&&a.length&&a.forEach(c=>c.classList.toggle("active",c.dataset.region===t));const l=document.querySelector("#regions");if(l){const c=Array.from(l.options).find(w=>w.value===t||w.text===t);c&&(l.value=c.value)}}function se(){const t=document.querySelector(".filtering-buttons button.active");if(t)return t.dataset.region||"All";const a=document.querySelector("#regions");return a&&a.value||"All"}const j=function(){let t=!1,a=null;function l(){return`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(k)}&libraries=places`}function c(f){return document.querySelector(`script[src="${f}"]`)?Promise.resolve():new Promise((p,A)=>{const d=document.createElement("script");d.src=f,d.async=!0,d.defer=!0;try{d.setAttribute("loading","lazy")}catch{}d.onload=()=>p(),d.onerror=()=>A(new Error("Failed to load Google Maps script")),document.head.appendChild(d)})}async function w(){if(!t)return a||(a=(async()=>{const f=l();await c(f);const p=Date.now();for(;!(window.google&&window.google.maps);){if(Date.now()-p>15e3)throw new Error("Timed out waiting for google.maps");await new Promise(A=>setTimeout(A,50))}t=!0;try{console.log("GoogleMapsAPI.load: Maps JS loaded",{hasGoogle:!!window.google,hasMaps:!!(window.google&&window.google.maps),version:window.google&&window.google.maps&&window.google.maps.version||"unknown"})}catch{}})(),a)}function g(f,p={}){if(!t)throw new Error("Google Maps not loaded. Call GoogleMapsAPI.load() first.");const A=typeof f=="string"?document.getElementById(f):f;if(!A)throw new Error("Map container not found: "+f);const d=new google.maps.Map(A,p);try{const u=d.getCenter&&d.getCenter(),y=d.getZoom&&d.getZoom();console.log("GoogleMapsAPI.initMap: map initialized",{zoom:typeof y=="number"?y:p.zoom,center:u?{lat:u.lat(),lng:u.lng()}:p.center||null})}catch{}const b=new Map;function G(u,y,{title:_="",icon:F=null,zIndex:e=1,onClick:s=null}={}){const o=new google.maps.Marker({map:d,position:y,title:_,icon:F,zIndex:e});return s&&o.addListener("click",()=>s(o,u)),b.set(u,o),o}function E(u){const y=b.get(u);y&&(y.setMap(null),b.delete(u))}function I(){for(const u of b.values())u.setMap(null);b.clear()}function v(u,y={}){const _=b.get(u);_&&(_.setZIndex(9999),y.bounce&&(_.setAnimation(google.maps.Animation.BOUNCE),setTimeout(()=>_.setAnimation(null),700)))}function M(u){if(u){if(typeof u=="string"){const y=D[u];y&&(d.setZoom(y.zoom),d.setCenter(y.center));return}if(u.center&&u.zoom){d.setCenter(u.center),d.setZoom(u.zoom);return}if(u.lat&&u.lng){d.setCenter(u);return}}}return{map:d,addMarker:G,removeMarker:E,clearMarkers:I,highlightMarker:v,setView:M}}return{load:w,get loaded(){return t},initMap:g,DEFAULT_COUNTRY_VIEW:U}}(),L="gtg-cache-v1",S="cache";function T(){return new Promise((t,a)=>{const l=indexedDB.open(L);l.onupgradeneeded=()=>{const c=l.result;c.objectStoreNames.contains(S)||c.createObjectStore(S,{keyPath:"key"})},l.onsuccess=()=>{const c=l.result;if(c.objectStoreNames.contains(S))t(c);else{const w=c.version+1;c.close();const g=indexedDB.open(L,w);g.onupgradeneeded=()=>{const f=g.result;f.objectStoreNames.contains(S)||f.createObjectStore(S,{keyPath:"key"})},g.onsuccess=()=>t(g.result),g.onerror=()=>a(g.error)}},l.onerror=()=>a(l.error)})}async function z(t,a){const l=await T();return new Promise((c,w)=>{const g=l.transaction(S,t),f=g.objectStore(S),p=a(f);g.oncomplete=()=>c(p.result),g.onabort=g.onerror=()=>w(g.error||new Error("IDB error"))})}async function J(t,a,l=24*60*60*1e3){try{const c={key:t,ts:Date.now(),ttl:l,value:a};return await z("readwrite",w=>w.put(c)),!0}catch(c){return console.warn("idbCache.setCache failed",c),!1}}async function W(t){try{const a=await z("readonly",l=>l.get(t));if(!a)return null;if(typeof a.ts=="number"&&typeof a.ttl=="number"&&Date.now()-a.ts>a.ttl){try{await O(t)}catch{}return null}return a.value}catch(a){return console.warn("idbCache.getCache failed",a),null}}async function O(t){try{return await z("readwrite",a=>a.delete(t)),!0}catch(a){return console.warn("idbCache.delCache failed",a),!1}}async function K(){try{const t=await T();return new Promise((a,l)=>{const c=t.transaction(S,"readwrite"),g=c.objectStore(S).openCursor();g.onsuccess=()=>{const f=g.result;if(!f)return;const p=f.value;p&&typeof p.ts=="number"&&typeof p.ttl=="number"&&Date.now()-p.ts>p.ttl&&f.delete(),f.continue()},c.oncomplete=()=>a(!0),c.onerror=()=>l(c.error)})}catch(t){return console.warn("idbCache.clearExpired failed",t),!1}}const R={setCache:J,getCache:W,delCache:O,clearExpired:K},N="places_cache_attractions_v1",$="places_cache_restaurants_v1",oe=function(){let t=[],a=[],l=null,c=!0;function w(){try{const e=sessionStorage.getItem(N),s=sessionStorage.getItem($);e&&(t=JSON.parse(e)||[]),s&&(a=JSON.parse(s)||[]);try{console.log("PlacesAPI: loaded session cache",{attractions:t.length,restaurants:a.length})}catch{}}catch(e){console.warn("Failed reading Places cache from sessionStorage",e)}}function g(){try{sessionStorage.setItem(N,JSON.stringify(t)),sessionStorage.setItem($,JSON.stringify(a))}catch(e){console.warn("Failed saving Places cache to sessionStorage",e)}}w();try{R.clearExpired()}catch{}const f=[{placeId:"sample-1",name:"Antigua Guatemala",types:["tourist_attraction"],status:"OPERATIONAL",location:{lat:14.556,lng:-90.734},address:"Antigua Guatemala",photos:[],region:"Metropolitan",raw:{}},{placeId:"sample-2",name:"Tikal National Park",types:["park","tourist_attraction"],status:"OPERATIONAL",location:{lat:17.223,lng:-89.623},address:"Tikal",photos:[],region:"Petén",raw:{}},{placeId:"sample-3",name:"Lake Atitlán",types:["natural_feature"],status:"OPERATIONAL",location:{lat:14.704,lng:-91.186},address:"Lake Atitlán",photos:[],region:"West",raw:{}}],p={Metropolitan:["Guatemala City","Guatemala City restaurants","restaurants in Guatemala City"],"Las Verapaces":["Las Verapaces","Verapaces Guatemala","restaurants in Las Verapaces"],Petén:["Petén","Petén Guatemala","restaurants in Petén"],"South Coast":["Pacific coast Guatemala","South Coast Guatemala","restaurants on the Pacific coast Guatemala"],West:["Quetzaltenango","Quetzaltenango restaurants","restaurants in Quetzaltenango"],Southeast:["Jutiapa","Jutiapa Guatemala restaurants","restaurants in Jutiapa"],Northeast:["Izabal","Izabal Guatemala restaurants","restaurants in Izabal"]};async function A(){try{if(await j.load(),!l&&window.google&&window.google.maps&&window.google.maps.places){const e=document.createElement("div"),s=new google.maps.Map(e);l=new google.maps.places.PlacesService(s)}l||(c=!1);try{console.log("PlacesAPI.ensure",{mapsAvailable:c,hasService:!!l})}catch{}}catch(e){console.warn("Google Maps failed to load, falling back to session cache if available",e),c=!1;try{console.log("PlacesAPI.ensure: maps unavailable, will use cache/fallback paths")}catch{}}}function d(e){const s=e.geometry&&e.geometry.location?{lat:e.geometry.location.lat(),lng:e.geometry.location.lng()}:null,o=e.photos&&e.photos.length?e.photos.map(r=>r.getUrl({maxWidth:800})):[],n=e.photos&&e.photos.length?e.photos.map(r=>r.photo_reference).filter(Boolean):[];let i=null;if(e.opening_hours)try{typeof e.opening_hours.isOpen=="function"?i=e.opening_hours.isOpen():typeof e.opening_hours.open_now<"u"&&(i=!!e.opening_hours.open_now)}catch{}return{placeId:e.place_id,name:e.name,types:(e.types||[]).slice(0,3),status:e.business_status||null,isOpen:i,location:s,address:e.formatted_address||e.vicinity||null,photos:o,photoRefs:n,region:s?V(s.lat,s.lng):"Center",raw:e}}function b(e){return e&&Array.isArray(e.photos)&&e.photos.length>0}function G(e){return new Promise((s,o)=>{if(!c||!l)return o(new Error("Places service not available"));l.textSearch(e,(n,i,r)=>{if(i!==window.google.maps.places.PlacesServiceStatus.OK&&i!==window.google.maps.places.PlacesServiceStatus.ZERO_RESULTS)return o(new Error("TextSearch failed: "+i));try{const P=(n||[]).slice(0,3).map(h=>({place_id:h.place_id,name:h.name,business_status:h.business_status,types:h.types,formatted_address:h.formatted_address||h.vicinity}));console.log("PlacesAPI.textSearch callback",{query:e&&e.query,status:i,count:(n||[]).length,sample:P})}catch{}s({results:n||[],pagination:r})})})}async function E(e){try{const s=await R.getCache(`places:detail:${e}`);if(s)return s}catch{}if(await A(),!c||!l)throw new Error("Places service not available");return new Promise((s,o)=>{l.getDetails({placeId:e,fields:["place_id","name","geometry","types","business_status","formatted_address","photos","opening_hours"]},async(n,i)=>{if(i!==window.google.maps.places.PlacesServiceStatus.OK)return o(new Error("getDetails failed: "+i));try{const h=n?{place_id:n.place_id,name:n.name,business_status:n.business_status,types:n.types,formatted_address:n.formatted_address||n.vicinity}:null;console.log("PlacesAPI.getDetails callback",{placeId:e,status:i,preview:h})}catch{}const r=d(n);try{console.log("PlacesAPI.getPlaceById result",{placeId:e,normalized:r})}catch{}const P=Object.assign({},r);try{delete P.raw}catch{}try{const h=await R.setCache(`places:detail:${e}`,P,864e5);console.debug(h?"PlacesAPI: cached place detail":"PlacesAPI: failed to persist place detail to idb",e)}catch(h){console.debug("PlacesAPI: idb setCache error",h)}try{console.log("PlacesAPI.fetchManySeeds: using cached seed results",{query:q,count:cached.length})}catch{}s(r)})})}async function I(e,s="attraction"){const o=B();try{console.log("PlacesAPI.fetchManySeeds: querying textSearch",{query:q})}catch{}const n=s==="restaurant"?o.restaurants:o.destinations;if(!n||!n.length)return e;for(const i of n)if(!e.find(r=>r.placeId===i)){try{const r=await E(i);r&&b(r)&&e.push(r)}catch(r){console.warn("Failed fetching favorite by id",i,r)}if(e.length>=100)break}return e.slice(0,100)}async function v(e){await A();const s=[];if(!c)return t.length?t.slice(0,100):a.length?a.slice(0,100):(console.warn("PlacesAPI: Maps not available and no cache present; returning empty list"),[]);for(const o of e){try{const n=await R.getCache(`places:text:${o}`);if(n&&Array.isArray(n)&&n.length){for(const i of n)s.find(r=>r.placeId===i.placeId)||s.push(i);if(s.length>=100)break;continue}}catch{}try{const{results:n}=await G({query:o});try{console.log("PlacesAPI.fetchManySeeds textSearch",{query:o,resultsCount:(n||[]).length})}catch{}const i=[];for(const r of n){const P=d(r);b(P)&&(s.find(h=>h.placeId===P.placeId)||s.push(P),i.push(P))}try{const r=i.map(h=>{const C=Object.assign({},h);try{delete C.raw}catch{}return C}).slice(0,50);await R.setCache(`places:text:${o}`,r,24*60*60*1e3)?console.debug("PlacesAPI: cached seed results for",o,r.length):console.debug("PlacesAPI: failed to persist seed cache for",o)}catch(r){console.debug("PlacesAPI: idb seed setCache error",r)}}catch(n){console.warn("textSearch seed failed",o,n)}if(s.length>=100)break}try{console.log("PlacesAPI.fetchManySeeds: aggregated results",{total:s.length,sample:s.slice(0,3)})}catch{}return s.slice(0,100)}async function M(){if(t.length)return t;t=await v(["tourist attractions in Guatemala","historic sites in Guatemala","national parks Guatemala","archaeological sites Guatemala","museums Guatemala","landmarks Guatemala"]),t=t.filter(s=>b(s)),(!t||t.length===0)&&!c&&(t=f.slice()),t=await I(t,"attraction"),g();try{console.log("PlacesAPI.fetchAttractions: returning",{count:t.length,sample:t.slice(0,3)})}catch{}return t}async function u(e="All",s=18){await A();try{console.log("PlacesAPI.fetchAttractionsForRegion start",{region:e,mapsAvailable:c})}catch{}if((e==="All"||!e)&&t.length)return I(t.slice(0,s),"attraction");const o=[];e&&e!=="All"?(o.push(`${e} tourist attractions`),o.push(`top sites in ${e}`),o.push(`${e} attractions Guatemala`)):o.push("tourist attractions in Guatemala");try{console.log("PlacesAPI.fetchAttractionsForRegion seeds",{region:e,seeds:o})}catch{}const n=await v(o),i=await I(n,"attraction");try{console.log("PlacesAPI.fetchAttractionsForRegion result",{region:e,count:i.length,sample:i.slice(0,3)})}catch{}return i.slice(0,s)}async function y(){if(a.length)return a;a=await v(["best restaurants in Guatemala","popular restaurants Guatemala","top restaurants Guatemala","local cuisine Guatemala"]),a=a.filter(s=>s.types&&s.types.includes("restaurant")),a=a.filter(s=>b(s)),a=await I(a,"restaurant"),(!a||a.length===0)&&!c&&(a=f.map((s,o)=>({placeId:`sample-restaurant-${o+1}`,name:`${s.name} Bistro`,types:["restaurant"],status:"OPERATIONAL",location:s.location,address:s.address,photos:[],region:s.region,raw:{}}))),g();try{console.log("PlacesAPI.fetchRestaurants: returning",{count:a.length,sample:a.slice(0,3)})}catch{}return a.slice(0,100)}async function _(e="All",s=18){await A();try{console.log("PlacesAPI.fetchRestaurantsForRegion start",{region:e,mapsAvailable:c})}catch{}if((e==="All"||!e)&&a.length)return I(a.slice(0,s),"restaurant");let o=[];e&&e!=="All"?p[e]?o=p[e].slice():(o.push(`${e} restaurants`),o.push(`best restaurants in ${e}`),o.push(`${e} local cuisine`)):o.push("best restaurants in Guatemala");try{console.log("PlacesAPI.fetchRestaurantsForRegion seeds",{region:e,seeds:o})}catch{}let n=await v(o);if(e&&e!=="All"){const r=(n||[]).filter(m=>m.region===e);if(r&&r.length){const m=await I(r,"restaurant");try{console.log("PlacesAPI.fetchRestaurantsForRegion exact match",{region:e,count:m.length,sample:m.slice(0,3)})}catch{}return m.slice(0,s)}const P=["best restaurants in Guatemala","popular restaurants Guatemala",`${e} near Guatemala City`],h=await v(P),C=(h||[]).filter(m=>m.region===e);if(C&&C.length){const m=await I(C,"restaurant");try{console.log("PlacesAPI.fetchRestaurantsForRegion fallback exact",{region:e,count:m.length,sample:m.slice(0,3)})}catch{}return m.slice(0,s)}if(n&&n.length){const m=await I(n,"restaurant");try{console.log("PlacesAPI.fetchRestaurantsForRegion nearby results",{region:e,count:m.length,sample:m.slice(0,3)})}catch{}return m.slice(0,s)}if(h&&h.length){const m=await I(h,"restaurant");try{console.log("PlacesAPI.fetchRestaurantsForRegion broad fallback",{region:e,count:m.length,sample:m.slice(0,3)})}catch{}return m.slice(0,s)}return[]}const i=await I(n,"restaurant");try{console.log("PlacesAPI.fetchRestaurantsForRegion all-region result",{region:e,count:i.length,sample:i.slice(0,3)})}catch{}return i.slice(0,s)}function F(e){const s={};for(const o of e){const n=o.region||"Center";s[n]||(s[n]=[]),s[n].push(o)}return s}return{fetchAttractions:M,fetchAttractionsForRegion:u,fetchRestaurants:y,fetchRestaurantsForRegion:_,groupByRegion:F,getPlaceById:E,_internal:{get attractions(){return t},get restaurants(){return a}}}}(),Z={};function Q(t){return t.photos&&t.photos.length?t.photos[0]:t&&Array.isArray(t.photoRefs)&&t.photoRefs.length&&k?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(t.photoRefs[0])}&key=${k}`:`${typeof import.meta<"u"&&Z?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/placeholder-2x1.svg`}function ne(t){return{id:t.placeId,name:t.name,image:Q(t),types:(t.types||[]).slice(0,3),status:t.status,coords:t.location,region:t.region}}const Y={};function H(t){return t.photos&&t.photos.length?t.photos[0]:t&&Array.isArray(t.photoRefs)&&t.photoRefs.length&&k?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(t.photoRefs[0])}&key=${k}`:`${typeof import.meta<"u"&&Y?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/restaurant-placeholder-1x1.svg`}function re(t){return{id:t.placeId,name:t.name,logo:H(t),types:(t.types||[]).slice(0,3),status:t.status,coords:t.location,region:t.region}}export{U as D,j as G,oe as P,D as R,ne as a,ae as b,te as c,se as d,ee as g,R as i,re as r};
