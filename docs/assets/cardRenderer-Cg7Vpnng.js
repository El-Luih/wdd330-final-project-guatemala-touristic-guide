import{googleKey as y,isFavorite as v,toggleFavorite as O,imageLoader as b}from"./util-DDZ2ozR1.js";import{i as L,a as Q}from"./PlaceDetails-DsYDr_P2.js";const V="modulepreload",z=function(e){return"/wdd330-final-project-guatemala-touristic-guide/"+e},I={},W=function(r,t,o){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),s=(n==null?void 0:n.nonce)||(n==null?void 0:n.getAttribute("nonce"));a=Promise.allSettled(t.map(d=>{if(d=z(d),d in I)return;I[d]=!0;const u=d.endsWith(".css"),p=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${p}`))return;const i=document.createElement("link");if(i.rel=u?"stylesheet":V,u||(i.as="script"),i.crossOrigin="",i.href=d,s&&i.setAttribute("nonce",s),document.head.appendChild(i),u)return new Promise((l,h)=>{i.addEventListener("load",l),i.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${d}`)))})}))}function c(n){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=n,window.dispatchEvent(s),!s.defaultPrevented)throw n}return a.then(n=>{for(const s of n||[])s.status==="rejected"&&c(s.reason);return r().catch(c)})},S={baseDelay:2500,maxRetries:2,ttlMs:60*60*1e3},M="__photoRefSessionBudget_v1",x=20;function H(){try{const e=sessionStorage.getItem(M);return e?parseInt(e,10)||0:x}catch{return x}}function X(e){try{sessionStorage.setItem(M,String(e))}catch{}}function Z(){const e=H();return e<=0?!1:(X(e-1),!0)}let w=[],U=!1;function k(e){return new Promise(r=>setTimeout(r,e))}function ee(e){try{const r=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",o=JSON.parse(r||"{}")[e];return o?Math.max(0,(o.cooldownUntil||0)-Date.now()):0}catch{return 0}}function A(e){if(e)try{const r=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",t=JSON.parse(r||"{}"),o=t[e]||{failures:0,cooldownUntil:0};o.failures=(o.failures||0)+1;const a=15e3,c=10*60*1e3,n=Math.min(a*Math.pow(2,Math.max(0,o.failures-1)),c);return o.cooldownUntil=Date.now()+n,t[e]=o,sessionStorage.setItem("__cardRenderer_hostFailures_v1",JSON.stringify(t)),o}catch{return null}}async function T(){if(!U){for(U=!0;w.length;){const e=w.shift(),{img:r,photoRef:t,retries:o=0,opts:a}=e;try{const c=`photoBlob:${t}`,n=await L.getCache(c);if(n&&n.type&&n.data)try{const i=q(n.data,n.type),l=URL.createObjectURL(i);r.src=l,r.onload=()=>{try{URL.revokeObjectURL(l)}catch{}};continue}catch{}const s=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(t)}&key=${encodeURIComponent(a.googleKey)}`;try{const l=new URL(s).host,h=ee(l);if(h>0){w.unshift(e),await k(Math.min(h,2e3));continue}}catch{}await k(200+Math.round(Math.random()*300));let d;try{d=await fetch(s,{method:"GET",mode:"cors",cache:"no-store"})}catch(i){try{const l=new URL(s);A(l.host)}catch{}throw i}if(!d.ok){try{const i=new URL(s);A(i.host)}catch{}throw new Error(`fetch failed ${d.status}`)}const u=await d.blob(),p=URL.createObjectURL(u);r.src=p,r.onload=()=>{try{URL.revokeObjectURL(p)}catch{}};try{const i=await te(u);await L.setCache(c,{type:u.type||"image/jpeg",data:i},a.ttlMs||S.ttlMs)}catch(i){console.warn("photoRefQueue: failed to cache blob",i)}}catch(c){if(o+1<=(a.maxRetries||S.maxRetries)){const n=o+1,s=(a.baseDelay||S.baseDelay)*Math.pow(2,o)+Math.round(Math.random()*400);w.unshift({img:r,photoRef:t,retries:n,opts:a}),await k(s)}else console.warn("photoRefQueue: giving up on",t,c)}}U=!1}}function N(e,r,t={}){return w.push({img:e,photoRef:r,retries:0,opts:t}),T(),!0}async function $(e,r,t={}){try{const o=`photoBlob:${r}`;try{const a=await L.getCache(o);if(a&&a.type&&a.data){const c=q(a.data,a.type),n=URL.createObjectURL(c);return e.src=n,e.onload=()=>{try{URL.revokeObjectURL(n)}catch{}},!0}}catch{}return Z()?(w.push({img:e,photoRef:r,retries:0,opts:t}),T(),!0):!1}catch{return!1}}function te(e){return new Promise((r,t)=>{const o=new FileReader;o.onloadend=()=>{const a=o.result,c=a.indexOf(",");if(c<0)return t(new Error("invalid dataurl"));const n=a.slice(c+1);r(n)},o.onerror=t,o.readAsDataURL(e)})}function q(e,r="image/jpeg"){const t=atob(e),o=new Array(t.length);for(let c=0;c<t.length;c++)o[c]=t.charCodeAt(c);const a=new Uint8Array(o);return new Blob([a],{type:r})}const E={enqueuePhotoRef:N,tryEnqueuePhotoRef:$},oe=Object.freeze(Object.defineProperty({__proto__:null,default:E,enqueuePhotoRef:N,tryEnqueuePhotoRef:$},Symbol.toStringTag,{value:"Module"})),ne={};function re(e){return e&&Array.isArray(e.photoRefs)&&e.photoRefs.length&&y?`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(e.photoRefs[0])}&key=${y}`:e.photos&&e.photos.length?e.photos[0]:`${typeof import.meta<"u"&&ne?"/wdd330-final-project-guatemala-touristic-guide/":"/"}images/restaurant-placeholder-1x1.svg`}function ae(e){return{id:e.placeId,name:e.name,logo:re(e),types:(e.types||[]).slice(0,3),status:e.status,coords:e.location,region:e.region}}const C={};let _=null;typeof window<"u"&&(window.__cardRendererRetryState||(window.__cardRendererRetryState={list:[],timerSet:!1}));const se=1e4,ce=800;function j(e,r){try{if(typeof window>"u"||!e)return;const t=window.__cardRendererRetryState;if(!t||t.list.some(o=>o.img===e))return;t.list.push({img:e,photoRef:r}),t.timerSet||(t.timerSet=!0,setTimeout(()=>{const o=Array.from(t.list);t.list=[],t.timerSet=!1,o.forEach((a,c)=>{const{img:n,photoRef:s}=a,d=c*ce;setTimeout(()=>{try{if(!n||!document.body.contains(n)||n.dataset.retryAttempted==="1")return;const u=n.getAttribute("src")||"";if(!/placeholder/.test(u)||!s||(typeof window<"u"&&window.__cardRendererPhotoRefState?window.__cardRendererPhotoRefState:{disabled:!1}).disabled||G(s)>P)return;n.dataset.retryAttempted="1";try{E.enqueuePhotoRef(n,s,{googleKey:y,baseDelay:2e3,maxRetries:3,ttlMs:60*60*1e3})}catch{}}catch{}},d)})},se))}catch{}}const F="__cardRenderer_photoRefFailures_v1";function D(){try{const e=sessionStorage.getItem(F)||"{}";return JSON.parse(e||"{}")}catch{return{}}}function ie(e){try{sessionStorage.setItem(F,JSON.stringify(e||{}))}catch{}}function B(e){if(e)try{const r=D();return r[e]=(r[e]||0)+1,ie(r),r[e]}catch{return null}}function G(e){if(!e)return 0;try{return D()[e]||0}catch{return 0}}const P=2,J="__cardRenderer_hostFailures_v1";function de(){try{return JSON.parse(sessionStorage.getItem(J)||"{}")}catch{return{}}}function ue(e){try{sessionStorage.setItem(J,JSON.stringify(e||{}))}catch{}}function le(e){try{const r=de(),t=r[e]||{failures:0,cooldownUntil:0};t.failures=(t.failures||0)+1;const o=1e4,a=5*60*1e3,c=Math.min(o*Math.pow(2,Math.max(0,t.failures-1)),a);return t.cooldownUntil=Date.now()+c,r[e]=t,ue(r),t}catch{return null}}function Y(e){return!e||typeof e!="string"?"":e.replace(/[-_]+/g," ").split(/\s+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")}function K(){return _||(_=new IntersectionObserver(async e=>{e.forEach(async r=>{if(!r.isIntersecting)return;const t=r.target,o=t.dataset.src;if(o)try{if(/maps.googleapis.com\/maps\/api\/place\/photo/.test(o))try{const c=new URL(o),n=c.searchParams.get("photoreference")||c.searchParams.get("photo_reference");if(n)try{try{if(!await E.tryEnqueuePhotoRef(t,n,{googleKey:y})){try{t.dataset.photoRefBlocked="1"}catch{}try{he(t,n)}catch{}}}catch{E.enqueuePhotoRef(t,n,{googleKey:y})}}catch{try{b.enqueue(t,o).then(()=>{try{t.removeAttribute("data-src")}catch{}}).catch(()=>{try{t.removeAttribute("data-src")}catch{}})}catch{}}else b.enqueue(t,o).then(()=>{try{t.removeAttribute("data-src")}catch{}}).catch(()=>{try{t.removeAttribute("data-src")}catch{}})}catch{b.enqueue(t,o).then(()=>{try{t.removeAttribute("data-src")}catch{}}).catch(()=>{try{t.removeAttribute("data-src")}catch{}})}else b.enqueue(t,o).then(()=>{try{t.removeAttribute("data-src")}catch{}}).catch(()=>{try{t.removeAttribute("data-src")}catch{}})}catch{try{b.enqueue(t,o)}catch{}}try{_.unobserve(t)}catch{}})},{rootMargin:"200px 0px"}),_)}function he(e,r){try{if(e.dataset.clickToLoadAttached==="1")return;e.dataset.clickToLoadAttached="1",e.title="Image blocked to avoid quota; click to load",e.style.cursor="pointer";const t=async o=>{o.preventDefault(),o.stopPropagation();try{const a=await W(()=>Promise.resolve().then(()=>oe),void 0),c=a.tryEnqueuePhotoRef||a.default&&a.default.tryEnqueuePhotoRef;if(typeof c=="function")if(await c(e,r,{googleKey:y})){try{e.removeAttribute("title")}catch{}try{e.style.cursor=""}catch{}try{delete e.dataset.photoRefBlocked}catch{}try{e.removeEventListener("click",t)}catch{}}else try{e.title="Still blocked — please try again later"}catch{}}catch(a){console.warn("click-to-load enqueue failed",a)}};e.addEventListener("click",t)}catch{}}function pe(e,{mapHelpers:r=null,onFiltersReapply:t=null}={}){const o=Q(e),a=document.createElement("article");a.className="result-card destination-card",a.dataset.placeId=o.id;const c=document.createElement("div");c.className="card-media ratio-2x1";const n=document.createElement("img");n.dataset.src=o.image,n.src=typeof import.meta<"u"&&C?"/wdd330-final-project-guatemala-touristic-guide/images/placeholder-2x1.svg":"/images/placeholder-2x1.svg",n.alt=o.name,n.onerror=()=>{if(!n.dataset.triedPhotoRef&&e&&e.photoRefs&&e.photoRefs.length&&y){n.dataset.triedPhotoRef="1",n.src=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(e.photoRefs[0])}&key=${y}`;return}const f=typeof import.meta<"u"&&C?"/wdd330-final-project-guatemala-touristic-guide/":"/";n.src=`${f}images/placeholder-2x1.svg`;try{const m=e&&e.photoRefs&&e.photoRefs.length?e.photoRefs[0]:null;if(n.dataset.triedPhotoRef==="1"&&m){const g=B(m)||0;try{le("lh3.googleusercontent.com")}catch{}g<=P&&j(n,m)}}catch{}},K().observe(n),c.appendChild(n),a.appendChild(c);const s=document.createElement("div");s.className="card-body";const d=document.createElement("h3");d.textContent=o.name,s.appendChild(d);const u=document.createElement("div");u.className="card-tags",(o.types||[]).forEach(f=>{const m=document.createElement("span");m.className="tag",m.textContent=Y(f),u.appendChild(m)}),s.appendChild(u);const p=document.createElement("div");p.className="card-status",p.textContent=o.status||"Unknown",s.appendChild(p);const i=document.createElement("div");i.className="card-actions";const l=document.createElement("a");l.href=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.name)}&query_place_id=${encodeURIComponent(o.id)}`,l.textContent="Open in Google Maps",l.target="_blank",i.appendChild(l);const h=document.createElement("button");return h.className="fav-button",h.textContent=v(o.id,"destination")?"★":"☆",h.type="button",h.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),O(o.id,"destination"),h.textContent=v(o.id,"destination")?"★":"☆",typeof t=="function"&&t()}),i.appendChild(h),s.appendChild(i),a.appendChild(s),a.addEventListener("click",()=>{e.location&&r&&typeof r.setView=="function"&&typeof r.highlightMarker=="function"&&(r.setView({lat:e.location.lat,lng:e.location.lng,zoom:14}),r.highlightMarker(e.placeId,{bounce:!0}))}),a}function ye(e,{mapHelpers:r=null,onFiltersReapply:t=null}={}){const o=ae(e);try{console.debug("createRestaurantCard",{id:o.id,name:o.name})}catch{}const a=document.createElement("article");a.className="result-card restaurant-card",a.dataset.placeId=o.id;const c=document.createElement("div");c.className="card-media ratio-1x1";const n=document.createElement("img");n.dataset.src=o.logo,n.src=typeof import.meta<"u"&&C?"/wdd330-final-project-guatemala-touristic-guide/images/restaurant-placeholder-1x1.svg":"/images/restaurant-placeholder-1x1.svg",n.alt=o.name,typeof window<"u"&&(window.__cardRendererPhotoRefState||(window.__cardRendererPhotoRefState={failures:0,disabled:!1})),n.onerror=()=>{const f=typeof window<"u"&&window.__cardRendererPhotoRefState?window.__cardRendererPhotoRefState:{failures:0,disabled:!1};if(!n.dataset.triedPhotoRef&&e&&e.photoRefs&&e.photoRefs.length&&y&&!f.disabled){n.dataset.triedPhotoRef="1",n.dataset.attemptedRef="1";try{n.src=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(e.photoRefs[0])}&key=${y}`}catch{}return}if(n.dataset.attemptedRef==="1"){try{f.failures=(f.failures||0)+1}catch{}try{const R=e&&e.photoRefs&&e.photoRefs.length?e.photoRefs[0]:null;R&&B(R)}catch{}if(f.failures>=3){try{f.disabled=!0}catch{}try{console.warn("cardRenderer: disabling photoRef retries after repeated failures")}catch{}}}const m=typeof import.meta<"u"&&C?"/wdd330-final-project-guatemala-touristic-guide/":"/";n.src=`${m}images/restaurant-placeholder-1x1.svg`;try{const g=e&&e.photoRefs&&e.photoRefs.length?e.photoRefs[0]:null;g&&!f.disabled&&G(g)<=P&&j(n,g)}catch{}},K().observe(n),c.appendChild(n),a.appendChild(c);const s=document.createElement("div");s.className="card-body";const d=document.createElement("h3");d.textContent=o.name,s.appendChild(d);const u=document.createElement("div");u.className="card-tags",(o.types||[]).slice(0,3).forEach(f=>{const m=document.createElement("span");m.className="tag",m.textContent=Y(f),u.appendChild(m)}),s.appendChild(u);const p=document.createElement("div");p.className="card-status",p.textContent=o.status||"Unknown",s.appendChild(p);const i=document.createElement("div");i.className="card-actions";const l=document.createElement("a");l.href=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.name)}&query_place_id=${encodeURIComponent(o.id)}`,l.textContent="Open in Google Maps",l.target="_blank",i.appendChild(l);const h=document.createElement("button");return h.type="button",h.className="fav-button",h.textContent=v(o.id,"restaurant")?"★":"☆",h.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation(),O(o.id,"restaurant"),h.textContent=v(o.id,"restaurant")?"★":"☆",typeof t=="function"&&t()}),i.appendChild(h),s.appendChild(i),a.appendChild(s),a.addEventListener("click",()=>{e.location&&r&&typeof r.setView=="function"&&typeof r.highlightMarker=="function"&&(r.setView({lat:e.location.lat,lng:e.location.lng,zoom:14}),r.highlightMarker(e.placeId,{bounce:!0}))}),a}export{W as _,pe as a,ye as c};
