import{i as w}from"./PlaceDetails-DsYDr_P2.js";import"./util-DDZ2ozR1.js";const p={baseDelay:2500,maxRetries:2,ttlMs:60*60*1e3},U="__photoRefSessionBudget_v1",R=20;function L(){try{const e=sessionStorage.getItem(U);return e?parseInt(e,10)||0:R}catch{return R}}function O(e){try{sessionStorage.setItem(U,String(e))}catch{}}function M(){const e=L();return e<=0?!1:(O(e-1),!0)}let l=[],y=!1;function b(e){return new Promise(o=>setTimeout(o,e))}function v(e){try{const o=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",t=JSON.parse(o||"{}")[e];return t?Math.max(0,(t.cooldownUntil||0)-Date.now()):0}catch{return 0}}function g(e){if(e)try{const o=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",r=JSON.parse(o||"{}"),t=r[e]||{failures:0,cooldownUntil:0};t.failures=(t.failures||0)+1;const n=15e3,a=10*60*1e3,s=Math.min(n*Math.pow(2,Math.max(0,t.failures-1)),a);return t.cooldownUntil=Date.now()+s,r[e]=t,sessionStorage.setItem("__cardRenderer_hostFailures_v1",JSON.stringify(r)),t}catch{return null}}async function S(){if(!y){for(y=!0;l.length;){const e=l.shift(),{img:o,photoRef:r,retries:t=0,opts:n}=e;try{const a=`photoBlob:${r}`,s=await w.getCache(a);if(s&&s.type&&s.data)try{const c=_(s.data,s.type),u=URL.createObjectURL(c);o.src=u,o.onload=()=>{try{URL.revokeObjectURL(u)}catch{}};continue}catch{}const i=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(r)}&key=${encodeURIComponent(n.googleKey)}`;try{const u=new URL(i).host,f=v(u);if(f>0){l.unshift(e),await b(Math.min(f,2e3));continue}}catch{}await b(200+Math.round(Math.random()*300));let h;try{h=await fetch(i,{method:"GET",mode:"cors",cache:"no-store"})}catch(c){try{const u=new URL(i);g(u.host)}catch{}throw c}if(!h.ok){try{const c=new URL(i);g(c.host)}catch{}throw new Error(`fetch failed ${h.status}`)}const d=await h.blob(),m=URL.createObjectURL(d);o.src=m,o.onload=()=>{try{URL.revokeObjectURL(m)}catch{}};try{const c=await E(d);await w.setCache(a,{type:d.type||"image/jpeg",data:c},n.ttlMs||p.ttlMs)}catch(c){console.warn("photoRefQueue: failed to cache blob",c)}}catch(a){if(t+1<=(n.maxRetries||p.maxRetries)){const s=t+1,i=(n.baseDelay||p.baseDelay)*Math.pow(2,t)+Math.round(Math.random()*400);l.unshift({img:o,photoRef:r,retries:s,opts:n}),await b(i)}else console.warn("photoRefQueue: giving up on",r,a)}}y=!1}}function x(e,o,r={}){return l.push({img:e,photoRef:o,retries:0,opts:r}),S(),!0}async function B(e,o,r={}){try{const t=`photoBlob:${o}`;try{const n=await w.getCache(t);if(n&&n.type&&n.data){const a=_(n.data,n.type),s=URL.createObjectURL(a);return e.src=s,e.onload=()=>{try{URL.revokeObjectURL(s)}catch{}},!0}}catch{}return M()?(l.push({img:e,photoRef:o,retries:0,opts:r}),S(),!0):!1}catch{return!1}}function E(e){return new Promise((o,r)=>{const t=new FileReader;t.onloadend=()=>{const n=t.result,a=n.indexOf(",");if(a<0)return r(new Error("invalid dataurl"));const s=n.slice(a+1);o(s)},t.onerror=r,t.readAsDataURL(e)})}function _(e,o="image/jpeg"){const r=atob(e),t=new Array(r.length);for(let a=0;a<r.length;a++)t[a]=r.charCodeAt(a);const n=new Uint8Array(t);return new Blob([n],{type:o})}const I={enqueuePhotoRef:x,tryEnqueuePhotoRef:B};export{I as default,x as enqueuePhotoRef,B as tryEnqueuePhotoRef};
