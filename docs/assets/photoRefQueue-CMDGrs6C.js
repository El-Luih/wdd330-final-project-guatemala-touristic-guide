import{i as b}from"./PlaceDetails-o1YsnpFD.js";import"./util-DDZ2ozR1.js";const p={baseDelay:2500,maxRetries:2,ttlMs:60*60*1e3},_="__photoRefSessionBudget_v1",g=20,I=6;function O(){try{const t=sessionStorage.getItem(_);return t?parseInt(t,10)||0:g}catch{return g}}function M(t){try{sessionStorage.setItem(_,String(t))}catch{}}function R(){const t=O();return t<=0?!1:(M(t-1),!0)}let l=[],y=!1;function m(t){return new Promise(o=>setTimeout(o,t))}function v(t){try{const o=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",e=JSON.parse(o||"{}")[t];return e?Math.max(0,(e.cooldownUntil||0)-Date.now()):0}catch{return 0}}function U(t){if(t)try{const o=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",n=JSON.parse(o||"{}"),e=n[t]||{failures:0,cooldownUntil:0};e.failures=(e.failures||0)+1;const r=15e3,s=10*60*1e3,a=Math.min(r*Math.pow(2,Math.max(0,e.failures-1)),s);return e.cooldownUntil=Date.now()+a,n[t]=e,sessionStorage.setItem("__cardRenderer_hostFailures_v1",JSON.stringify(n)),e}catch{return null}}async function S(){if(!y){for(y=!0;l.length;){const t=l.shift(),{img:o,photoRef:n,retries:e=0,opts:r}=t;try{const s=`photoBlob:${n}`,a=await b.getCache(s);if(a&&a.type&&a.data)try{const c=L(a.data,a.type),u=URL.createObjectURL(c);o.src=u,o.onload=()=>{try{URL.revokeObjectURL(u)}catch{}};continue}catch{}const i=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(n)}&key=${encodeURIComponent(r.googleKey)}`;try{const u=new URL(i).host,d=v(u);if(d>0){l.unshift(t),await m(Math.min(d,2e3));continue}}catch{}await m(200+Math.round(Math.random()*300));let h;try{h=await fetch(i,{method:"GET",mode:"cors",cache:"no-store"})}catch(c){try{const u=new URL(i);U(u.host)}catch{}throw c}if(!h.ok){try{const c=new URL(i);U(c.host)}catch{}throw new Error(`fetch failed ${h.status}`)}const f=await h.blob(),w=URL.createObjectURL(f);o.src=w,o.onload=()=>{try{URL.revokeObjectURL(w)}catch{}};try{const c=await A(f);await b.setCache(s,{type:f.type||"image/jpeg",data:c},r.ttlMs||p.ttlMs)}catch(c){console.warn("photoRefQueue: failed to cache blob",c)}}catch(s){if(e+1<=(r.maxRetries||p.maxRetries)){const a=e+1,i=(r.baseDelay||p.baseDelay)*Math.pow(2,e)+Math.round(Math.random()*400);l.unshift({img:o,photoRef:n,retries:a,opts:r}),await m(i)}else console.warn("photoRefQueue: giving up on",n,s)}}y=!1}}function E(t,o,n={}){return l.push({img:t,photoRef:o,retries:0,opts:n}),S(),!0}async function x(t,o,n={}){try{const e=`photoBlob:${o}`;try{const r=await b.getCache(e);if(r&&r.type&&r.data){const s=L(r.data,r.type),a=URL.createObjectURL(s);return t.src=a,t.onload=()=>{try{URL.revokeObjectURL(a)}catch{}},!0}}catch{}try{const r=parseInt(sessionStorage.getItem("__photoRefAutoLimit_v1"),10)||I,s="__photoRefAutoUsed_v1",a=parseInt(sessionStorage.getItem(s),10)||0;if(a>=r||!R())return!1;sessionStorage.setItem(s,String(a+1))}catch{if(!R())return!1}return l.push({img:t,photoRef:o,retries:0,opts:n}),S(),!0}catch{return!1}}function A(t){return new Promise((o,n)=>{const e=new FileReader;e.onloadend=()=>{const r=e.result,s=r.indexOf(",");if(s<0)return n(new Error("invalid dataurl"));const a=r.slice(s+1);o(a)},e.onerror=n,e.readAsDataURL(t)})}function L(t,o="image/jpeg"){const n=atob(t),e=new Array(n.length);for(let s=0;s<n.length;s++)e[s]=n.charCodeAt(s);const r=new Uint8Array(e);return new Blob([r],{type:o})}const j={enqueuePhotoRef:E,tryEnqueuePhotoRef:x};export{j as default,E as enqueuePhotoRef,x as tryEnqueuePhotoRef};
