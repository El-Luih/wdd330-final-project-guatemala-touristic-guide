import{i as b}from"./PlaceDetails-CwexVQxr.js";import"./util-DDZ2ozR1.js";const h={baseDelay:1500,maxRetries:3,ttlMs:60*60*1e3},y="__photoRefSessionBudget_v1",m=20;function g(){try{const e=sessionStorage.getItem(y);return e?parseInt(e,10)||0:m}catch{return m}}function w(e){try{sessionStorage.setItem(y,String(e))}catch{}}function R(){const e=g();return e<=0?!1:(w(e-1),!0)}let i=[],f=!1;function U(e){return new Promise(t=>setTimeout(t,e))}async function S(e){const t=await fetch(e,{method:"GET",mode:"cors",cache:"no-store"});if(!t.ok)throw new Error(`fetch failed ${t.status}`);return await t.blob()}async function B(){if(!f){for(f=!0;i.length;){const e=i.shift(),{img:t,photoRef:o,retries:r=0,opts:a}=e;try{const n=`photoBlob:${o}`,s=await b.getCache(n);if(s&&s.type&&s.data)try{const c=O(s.data,s.type),d=URL.createObjectURL(c);t.src=d,t.onload=()=>{try{URL.revokeObjectURL(d)}catch{}};continue}catch{}const u=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(o)}&key=${encodeURIComponent(a.googleKey)}`,l=await S(u),p=URL.createObjectURL(l);t.src=p,t.onload=()=>{try{URL.revokeObjectURL(p)}catch{}};try{const c=await E(l);await b.setCache(n,{type:l.type||"image/jpeg",data:c},a.ttlMs||h.ttlMs)}catch(c){console.warn("photoRefQueue: failed to cache blob",c)}}catch(n){if(r+1<=(a.maxRetries||h.maxRetries)){const s=r+1,u=(a.baseDelay||h.baseDelay)*Math.pow(2,r)+Math.round(Math.random()*200);i.unshift({img:t,photoRef:o,retries:s,opts:a}),await U(u)}else console.warn("photoRefQueue: giving up on",o,n)}}f=!1}}function L(e,t,o={}){return R()?(i.push({img:e,photoRef:t,retries:0,opts:o}),B(),!0):!1}function E(e){return new Promise((t,o)=>{const r=new FileReader;r.onloadend=()=>{const a=r.result,n=a.indexOf(",");if(n<0)return o(new Error("invalid dataurl"));const s=a.slice(n+1);t(s)},r.onerror=o,r.readAsDataURL(e)})}function O(e,t="image/jpeg"){const o=atob(e),r=new Array(o.length);for(let n=0;n<o.length;n++)r[n]=o.charCodeAt(n);const a=new Uint8Array(r);return new Blob([a],{type:t})}const j={enqueuePhotoRef:L};export{j as default,L as enqueuePhotoRef};
