import{i as b}from"./RestaurantDetails-HJ4OFW7K.js";import"./util-CLfP8upw.js";const p={baseDelay:2500,maxRetries:2,ttlMs:60*60*1e3},_="__photoRefSessionBudget_v1",g=20,I=6;function O(){try{const e=sessionStorage.getItem(_);return e?parseInt(e,10)||0:g}catch{return g}}function M(e){try{sessionStorage.setItem(_,String(e))}catch{}}function R(){const e=O();return e<=0?!1:(M(e-1),!0)}let h=[],y=!1;function m(e){return new Promise(o=>setTimeout(o,e))}function v(e){try{const o=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",t=JSON.parse(o||"{}")[e];return t?Math.max(0,(t.cooldownUntil||0)-Date.now()):0}catch{return 0}}function U(e){if(e)try{const o=sessionStorage.getItem("__cardRenderer_hostFailures_v1")||"{}",n=JSON.parse(o||"{}"),t=n[e]||{failures:0,cooldownUntil:0};t.failures=(t.failures||0)+1;const r=15e3,s=10*60*1e3,a=Math.min(r*Math.pow(2,Math.max(0,t.failures-1)),s);return t.cooldownUntil=Date.now()+a,n[e]=t,sessionStorage.setItem("__cardRenderer_hostFailures_v1",JSON.stringify(n)),t}catch{return null}}async function S(){if(!y){for(y=!0;h.length;){const e=h.shift(),{img:o,photoRef:n,retries:t=0,opts:r}=e;try{const s=`photoBlob:${n}`,a=await b.getCache(s);if(a&&a.type&&a.data)try{const c=L(a.data,a.type),u=URL.createObjectURL(c);o.src=u,o.onload=()=>{try{URL.revokeObjectURL(u)}catch{}};continue}catch{}const i=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${encodeURIComponent(n)}&key=${encodeURIComponent(r.googleKey)}`;try{const u=new URL(i).host,d=v(u);if(d>0){h.unshift(e),await m(Math.min(d,2e3));continue}}catch{}await m(200+Math.round(Math.random()*300));let l;try{l=await fetch(i,{method:"GET",mode:"cors",cache:"no-store"});try{console.log("photoRefQueue fetch",{url:i,ok:l.ok,status:l.status})}catch{}}catch(c){try{const u=new URL(i);U(u.host)}catch{}throw c}if(!l.ok){try{const c=new URL(i);U(c.host)}catch{}throw new Error(`fetch failed ${l.status}`)}const f=await l.blob();try{console.log("photoRefQueue blob size",{url:i,size:f.size,type:f.type})}catch{}const w=URL.createObjectURL(f);o.src=w,o.onload=()=>{try{URL.revokeObjectURL(w)}catch{}};try{const c=await A(f);await b.setCache(s,{type:f.type||"image/jpeg",data:c},r.ttlMs||p.ttlMs)}catch(c){console.warn("photoRefQueue: failed to cache blob",c)}}catch(s){if(t+1<=(r.maxRetries||p.maxRetries)){const a=t+1,i=(r.baseDelay||p.baseDelay)*Math.pow(2,t)+Math.round(Math.random()*400);h.unshift({img:o,photoRef:n,retries:a,opts:r}),await m(i)}else console.warn("photoRefQueue: giving up on",n,s)}}y=!1}}function E(e,o,n={}){return h.push({img:e,photoRef:o,retries:0,opts:n}),S(),!0}async function x(e,o,n={}){try{const t=`photoBlob:${o}`;try{const r=await b.getCache(t);if(r&&r.type&&r.data){const s=L(r.data,r.type),a=URL.createObjectURL(s);return e.src=a,e.onload=()=>{try{URL.revokeObjectURL(a)}catch{}},!0}}catch{}try{const r=parseInt(sessionStorage.getItem("__photoRefAutoLimit_v1"),10)||I,s="__photoRefAutoUsed_v1",a=parseInt(sessionStorage.getItem(s),10)||0;if(a>=r||!R())return!1;sessionStorage.setItem(s,String(a+1))}catch{if(!R())return!1}return h.push({img:e,photoRef:o,retries:0,opts:n}),S(),!0}catch{return!1}}function A(e){return new Promise((o,n)=>{const t=new FileReader;t.onloadend=()=>{const r=t.result,s=r.indexOf(",");if(s<0)return n(new Error("invalid dataurl"));const a=r.slice(s+1);o(a)},t.onerror=n,t.readAsDataURL(e)})}function L(e,o="image/jpeg"){const n=atob(e),t=new Array(n.length);for(let s=0;s<n.length;s++)t[s]=n.charCodeAt(s);const r=new Uint8Array(t);return new Blob([r],{type:o})}const j={enqueuePhotoRef:E,tryEnqueuePhotoRef:x};export{j as default,E as enqueuePhotoRef,x as tryEnqueuePhotoRef};
